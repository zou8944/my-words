---
created_at: 2022-03-05 13:14:47
updated_at: 2022-03-05 13:14:47
slug: java-unit-test-tools
tags:
  - Junit5
  - MockK
  - AssertK
  - å•å…ƒæµ‹è¯•
---

å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚å†™å•å…ƒæµ‹è¯•ï¼Œéœ€è¦ä¸‰ç±»å·¥å…·

- æµ‹è¯•å¹³å°ï¼šJUnitã€TestNG
- Mockæ¡†æ¶ï¼šMockitoã€MockK
- æ–­è¨€æ¡†æ¶ï¼šAssertJã€Assertk

å½“å¼€å‘è¯­è¨€ä¸ºkotlinæ—¶ï¼Œæ¨èJUnit5 + MockK + Assertkçš„ç»„åˆã€‚

<!--more-->

# JUnit

æµ‹è¯•æ¡†æ¶æ‰¿è½½å•å…ƒæµ‹è¯•è¿è¡Œçš„ç¯å¢ƒï¼ŒåŸºç¡€æŠ€æœ¯ã€‚ä¸€èˆ¬ä¼šæåˆ°JUnitå’ŒTestNGï¼ŒSpringé»˜è®¤é›†æˆäº†JUnit5ï¼Œåè€…ç”±äºæ²¡æœ‰å…·ä½“ä½¿ç”¨è¿‡ï¼Œä¸å¤§å¥½ä½œè¯„è®ºï¼Œä½†æ˜¯ç½‘ä¸Šæ–‡ç« æœäº†ä¸€åœˆï¼Œç›¸æ¯”äºJUnit5ï¼ŒTestNGå¹¶æ²¡æœ‰çœ‹å‡ºä»€ä¹ˆä¼˜åŠ¿ï¼Œå…·æœ‰å·®ä¸å¤šçš„åŠŸèƒ½ï¼Œä½†æ˜¯éœ€è¦å†™xmlã€‚å¤„äºå¥½å¥‡çœ‹äº†ä¸‹ä¸¤è€…çš„å‘å¸ƒæ—¶é—´ï¼ŒJUnit5è¯ç”Ÿçš„æ—¥æœŸã€æ›´æ–°çš„é¢‘ç¹ç¨‹åº¦éƒ½è¾ƒé«˜ï¼Œæ‰€ä»¥å€¾å‘ä½¿ç”¨JUnit5ï¼Œè‡³äºJUnit4ï¼Œç°åœ¨å·²ç»è¿‡æ—¶äº†ã€‚

| æ¡†æ¶   | é¦–ç‰ˆå‘å¸ƒæ—¥æœŸ    | é¦–ä¸ªæ­£å¼ç‰ˆå‘å¸ƒæ—¥æœŸ | æœ€è¿‘ä¸€ä¸ªæ­£å¼ç‰ˆå‘å¸ƒæ—¥æœŸ | æ›´æ–°é¢‘ç‡     |
| ------ | --------------- | ------------------ | ---------------------- | ------------ |
| JUnit4 | 2014-7-29       | 2014-7-29          | 2021-2-14              | ä¸€å¹´å·¦å³     |
| JUnit5 | alphaç‰ˆ2016-2-1 | 2017-10-03         | 2021-11-29             | ä¸€ä¸¤ä¸ªæœˆä¸€æ¬¡ |
| TestNG | 2010å¾€å‰        | 2010å¾€å‰           | 2022-1-3               | ä¸€å¹´å·¦å³     |

## æ¦‚è§ˆ

æ³¨æ„åŒºåˆ†å®ƒæœ‰4ã€5ä¸¤ä¸ªç‰ˆæœ¬ï¼Œåè€…ä¸ºæœ€æ–°ç‰ˆï¼Œä¹Ÿæ˜¯æåŠ›æ¨å¹¿çš„ç‰ˆæœ¬ï¼ŒåŠŸèƒ½ä¸°å¯Œäº†ä¸å°‘ã€‚ç»„æˆå¦‚ä¸‹

JUnit 5 = JUnit Platform + JUnit Jupiter + JUnit Vintage

JUnit Platformï¼šåœ¨JVMä¸­å¯åŠ¨æµ‹è¯•çš„åŸºç¡€ï¼›åŒæ—¶æä¾›å¼€å‘æµ‹è¯•å¼•æ“çš„API

JUnit Jupiterï¼šæ˜¯å†™å•å…ƒæµ‹è¯•çš„ç¼–ç¨‹æ¨¡å‹ã€æ‰©å±•æ¨¡å‹çš„ç»“åˆï¼›æä¾›è·‘åŸºäºjuipteræµ‹è¯•çš„æµ‹è¯•å¼•æ“

JUnit Vintageï¼šæä¾›åœ¨å½“å‰å¹³å°è·‘JUnit3å’ŒJUnit4çš„æµ‹è¯•å¼•æ“

> JUnit5æœ€ä½æ”¯æŒJDK8

> æœ‰å…³JUnitçš„å…¨éƒ¨åŠŸèƒ½ï¼Œå‚è€ƒ[å®˜æ–¹æ‰‹å†Œ](https://junit.org/junit5/docs/current/user-guide/)ï¼Œå»ºè®®ä»å¤´åˆ°å°¾çœ‹ä¸€éï¼Œäº†è§£ä¸€ä¸‹æœ‰å“ªäº›å‹å·çš„é”¤å­ã€‚

## åŸºæœ¬æ¦‚å¿µ

æŒæ¡ä¸‰ä¸ªåŸºæœ¬æ¦‚å¿µ

- æµ‹è¯•ç±»

  å¦‚ä¸‹ä¸‰ç§ç±»å¯ä»¥è¢«ç§°ä½œé™æ€ç±»ï¼Œå¹¶ä¸”å®ƒä»¬å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªæµ‹è¯•æ–¹æ³•

  - é¡¶çº§ç±»
  - é™æ€å†…éƒ¨ç±»
  - è¢«@Nestedæ³¨è§£çš„éé™æ€å†…éƒ¨ç±»

- æµ‹è¯•æ–¹æ³•

  è¢«@Test,@RepeatedTest, @ParameterizedTest, @TestFactory, or @TestTemplateæ³¨è§£çš„å®ä¾‹æ–¹æ³•

- ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

  è¢«@BeforeAll,@AfterAll, @BeforeEach, or @AfterEachæ³¨è§£çš„æ–¹æ³•

æ³¨æ„äº‹é¡¹

- é™¤@TestFactoryæ³¨è§£çš„æ–¹æ³•å¤–ï¼Œæµ‹è¯•æ–¹æ³•ä¸èƒ½æœ‰è¿”å›å€¼
- æµ‹è¯•ç±»ã€æµ‹è¯•æ–¹æ³•ä¸å¿…æ˜¯publicçš„ï¼Œä½†ä¹Ÿä¸èƒ½æ˜¯privateçš„
- å¯¹äºJavaæ¥è¯´ï¼ŒJUnitå»ºè®®çœç•¥æ‰ç±»å’Œæ–¹æ³•çš„publicå…³é”®å­—

## æ³¨è§£å’ŒåŠŸèƒ½è§£é‡Š

JUnitæœ‰21ä¸ªä»¥ä¸Šçš„æ³¨è§£ï¼Œæˆ‘ä»¬æŒ‘é€‰å…¶ä¸­æœ€å¸¸ç”¨çš„çœ‹

| æ³¨è§£                                                       | è¯´æ˜                                                         |
| ---------------------------------------------------------- | ------------------------------------------------------------ |
| @Test                                                      | æ ‡è®°ä¸€ä¸ªæµ‹è¯•æ–¹æ³•                                             |
| @ParameterizedTest                                         | å‚æ•°åŒ–æµ‹è¯•ï¼Œä¸æ•°æ®æºæ³¨è§£ååŒä½¿ç”¨                             |
| @RepeatedTest                                              | é‡å¤æ‰§è¡Œçš„æ–¹æ³•ï¼Œå³ä¸€ä¸ªæ–¹æ³•è¢«æ‰§è¡Œå¤šæ¬¡                         |
| @DisplayName                                               | æ˜¾ç¤ºåœ¨æµ‹è¯•æŠ¥å‘Šä¸­çš„åç§°<br />æ³¨ï¼šéƒ¨åˆ†æ³¨è§£æœ‰nameå±æ€§ï¼Œä¹Ÿå¯ä»¥æŒ‡å®š |
| @Nested                                                    | è¡¨æ˜è¢«æ³¨è§£çš„ç±»æ˜¯éé™æ€çš„åµŒå¥—ç±»ï¼›ä¸»è¦ç”¨æ¥åˆ†ç»„                 |
| @Tag                                                       | æ ‡ç­¾ï¼Œç”¨äºè¿‡æ»¤<br />å’ŒTestNGä¸­çš„ç»„æ¦‚å¿µç±»ä¼¼<br />å’ŒJUnit4ä¸­çš„åˆ†ç±»æ¦‚å¿µç±»ä¼¼ |
| @BeforeAll<br />@AfterAll<br />@BeforeEach<br />@AfterEach | ç”Ÿå‘½å‘¨æœŸæ–¹æ³•                                                 |
| @Timeout                                                   | æ–¹æ³•æ‰§è¡Œçš„è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åˆ™æŠ¥é”™                               |
| @ExtendWith                                                | å£°æ˜å¼æ‰©å±•                                                   |
| @RegisterExtension                                         | ç¼–ç¨‹å¼æ‰©å±•                                                   |

## ä¸€ä¸ªä¾‹å­

ä½¿ç”¨Kotlinç¼–å†™çš„ä¸¤ä¸ªå·¥å…·æµ‹è¯•æ–¹æ³•

```kotlin
/**
 * å°†ç±»Sçš„åŒåå±æ€§å¡«å……åˆ°Dä¸­
 * è¦æ±‚æºå¯¹è±¡çš„å±æ€§å¿…é¡»æœ‰getteræ–¹æ³•ï¼Œä¸”ï¼Œç›®æ ‡å¯¹è±¡çš„å±æ€§å¿…é¡»æœ‰setteræ–¹æ³•ï¼Œå¦åˆ™å¤åˆ¶ä¸ä¼šæˆåŠŸ
 */
fun <S, D> D.fillWith(source: S): D = apply {
    BeanUtils.copyProperties(source, this)
}
/**
 * ä»ä¸€ä¸ªé“¾æ¥ä¸­è§£æå‡ºossçš„object keyï¼Œå¦‚æœå®ƒä¸æ˜¯ossçš„é“¾æ¥ï¼Œè§£æç»“æœä¸ºnull
 */
fun String.parseOssObjectKey(): String? {
    if (this.startsWith("http", true)) {
        return URL(this).path.trim('/')
    }
    return null
}
```

å¯¹åº”çš„å•å…ƒæµ‹è¯•å¦‚ä¸‹

```kotlin
@DisplayName("å…¨å±€æ‰©å±•æ–¹æ³•æµ‹è¯•")
class ExtensionMethodTest {

    companion object {

        @BeforeAll
        @JvmStatic
        fun beforeAll() {
            println("å…¨å±€å¼€å§‹")
        }

        @AfterAll
        @JvmStatic
        fun afterAll() {
            println("å…¨å±€ç»“æŸ")
        }
    }

    @BeforeEach
    fun beforeEach(info: TestInfo) {
        println("${info.displayName}å¼€å§‹")
    }

    @AfterEach
    fun afterEach(info: TestInfo) {
        println("${info.displayName}ç»“æŸ")
    }

    @Nested
    @DisplayName("D.fillWith(S)")
    inner class FillWith {

        @Test
        fun `fail case`() {
            val source = NonInheritanceValClass(
                field1 = "1",
                field2 = 1,
                field3 = false,
                fieldA = listOf<String>()
            )
            val destination = NonInheritanceValClass()

            destination.fillWith(source)

            assertAll {
                assertThat(destination.field1).isNull()
                assertThat(destination.field2).isNull()
                assertThat(destination.field3).isNull()
                assertThat(destination.fieldA).isNull()
            }
        }

    }

    @Nested
    @DisplayName("String.parseOssObjectKey()")
    inner class ParseOssObjectKey {

        @ParameterizedTest(name = ParameterizedTest.ARGUMENTS_WITH_NAMES_PLACEHOLDER)
        @CsvSource(
            value = [
                "https://mylogs-oss.wemore.com/image/hello.jpg, image/hello.jpg",
                "https://mylogs-oss.moumoux.com/image/hello.jpg, image/hello.jpg",
                "http://mylogs-oss.moumoux.com/image/hello.jpg, image/hello.jpg"
            ], nullValues = ["null"]
        )
        fun `just test`(input: String, expectedOutput: String?) {
            val result = input.parseOssObjectKey()
            assertThat(result).isEqualTo(expectedOutput)
        }
    }

}
```

è¿è¡Œæ•´ä¸ªæµ‹è¯•ç±»ï¼Œèƒ½å¤Ÿå¾—åˆ°å¦‚ä¸‹è¾“å‡º

```shell
å…¨å±€å¼€å§‹
fail case()å¼€å§‹
fail case()ç»“æŸ
input=https://mylogs-oss.wemore.com/image/hello.jpg, expectedOutput=image/hello.jpgå¼€å§‹
input=https://mylogs-oss.wemore.com/image/hello.jpg, expectedOutput=image/hello.jpgç»“æŸ
input=https://mylogs-oss.moumoux.com/image/hello.jpg, expectedOutput=image/hello.jpgå¼€å§‹
input=https://mylogs-oss.moumoux.com/image/hello.jpg, expectedOutput=image/hello.jpgç»“æŸ
input=http://mylogs-oss.moumoux.com/image/hello.jpg, expectedOutput=image/hello.jpgå¼€å§‹
input=http://mylogs-oss.moumoux.com/image/hello.jpg, expectedOutput=image/hello.jpgç»“æŸ
å…¨å±€ç»“æŸ
å…¨å±€æ‰©å±•æ–¹æ³•æµ‹è¯• > D.fillWith(S) > fail case() PASSED
å…¨å±€æ‰©å±•æ–¹æ³•æµ‹è¯• > String.parseOssObjectKey() > input=https://mylogs-oss.wemore.com/image/hello.jpg, expectedOutput=image/hello.jpg PASSED
å…¨å±€æ‰©å±•æ–¹æ³•æµ‹è¯• > String.parseOssObjectKey() > input=https://mylogs-oss.moumoux.com/image/hello.jpg, expectedOutput=image/hello.jpg PASSED
å…¨å±€æ‰©å±•æ–¹æ³•æµ‹è¯• > String.parseOssObjectKey() > input=http://mylogs-oss.moumoux.com/image/hello.jpg, expectedOutput=image/hello.jpg PASSED
```

ä¸Šé¢çš„ä¾‹å­å¯ä»¥æ€»ç»“å‡ºå‡ ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªçœ‹

1. å¦‚ä½•å¯åŠ¨é‚£ä¸ªæµ‹è¯•ç±»ï¼Ÿå¯èƒ½åœ¨IEADä¸­æœ‰å¯åŠ¨æŒ‰é’®ï¼Œä½†æ˜¯å¦‚æœåªæ˜¯ç»™äº†ä¸€ä¸ªç±»æ–‡ä»¶ï¼Œæˆ‘ä»¬è¦å¦‚ä½•å¯åŠ¨å‘¢ï¼Ÿåœ¨CIæ„å»ºæ—¶è¦å¦‚ä½•å¯åŠ¨å‘¢ï¼Ÿ
2. ä¸ºä»€ä¹ˆè¦ç”¨åµŒå¥—ç±»ï¼Ÿ
3. @BeforeAllçš„ä½¿ç”¨çœ‹èµ·æ¥å¾ˆä¸æ–¹ä¾¿ï¼Ÿ
4. æµ‹è¯•caseçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€æ ·çš„ï¼Ÿ
5. å‚æ•°åŒ–æµ‹è¯•ï¼Œè¿˜æ”¯æŒåˆ«çš„è®¾ç½®å‚æ•°çš„æ–¹å¼å—ï¼Ÿ

## å¯åŠ¨

ä¸‰ç§å¯åŠ¨æ–¹å¼

- Console Launcher

  æä¾›ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ junit-platform-console-standalone-1.8.2.jar ï¼Œç”¨å¦‚ä¸‹å‘½ä»¤æ‰§è¡Œæµ‹è¯•

  ```shell
  java -jar junit-platform-console-standalone-1.8.2.jar <é¢å¤–é€‰é¡¹>
  ```

  è¿™ç§åœºæ™¯è¿˜æ²¡ç”¨è¿‡

- IDEAæ’ä»¶ â€”â€” å¼€å‘æœ€å¸¸ç”¨

  åˆ°IDEAçš„æ’ä»¶å¸‚åœºæœç´¢junitï¼Œå®‰è£…æ’ä»¶å°±èƒ½ç›´æ¥æµ‹è¯•ï¼ˆå¯ä»¥çœ‹åˆ°ï¼Œjunitæ’ä»¶æ˜¯è½¯ä»¶ç»‘å®šçš„ï¼Œé»˜è®¤å·²ç»å®‰è£…äº†ï¼Œç”šè‡³æ²¡æœ‰å¸è½½é€‰é¡¹ï¼‰

  <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/local/image-20220226175402518.png" alt="image-20220226175402518" style="zoom:80%;" />

  æ­¤æ—¶å†™çš„æµ‹è¯•ç±»å’Œæ–¹æ³•ä¸Šå°±ä¼šæœ‰è¿è¡ŒæŒ‰é’®

  <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/local/image-20220226175613488.png" alt="image-20220226175613488" style="zoom:80%;" />

- gradleæ’ä»¶ â€”â€” CIæœ€å¸¸ç”¨

  ä½¿ç”¨gradleæ„å»ºæ—¶éœ€è¦æ·»åŠ junitæ’ä»¶ã€‚åŒæ ·ï¼Œgradleå·²ç»å°†JUnitæ·»åŠ åˆ°testä»»åŠ¡çš„é»˜è®¤æ”¯æŒå·¥å…·ä¸­ï¼ŒåŒæ ·æ”¯æŒçš„è¿˜æœ‰JUnit4ã€TestNGã€‚è¯¦æƒ…å‚è€ƒ[gradleçš„æµ‹è¯•æ–‡æ¡£](https://docs.gradle.org/current/userguide/java_testing.html)ï¼Œå¯é…ç½®çš„å‚æ•°æ¯”è¾ƒå¤šï¼Œä¸€ä¸ªè¾ƒä¸ºç®€å•çš„é…ç½®å¦‚ä¸‹

  ```groovy
  test {
      // ä½¿ç”¨JUnit5è¿›è¡Œæµ‹è¯•
      useJUnitPlatform()
      // æµ‹è¯•çº¿ç¨‹æ•°ï¼š2
      maxParallelForks(2)
      // æ—¥å¿—é…ç½®
      testLogging {
          // level=LIFECYCLEçš„é…ç½®é¡¹
          events "passed", "skipped", "failed"
          exceptionFormat "full"
      }
  }
  ```

## æµ‹è¯•ç”Ÿå‘½å‘¨æœŸ

ä¸€ä¸ªæµ‹è¯•ç±»å¯åŠ¨åï¼Œç”Ÿå‘½å‘¨æœŸä»ä¸Šåˆ°ä¸‹ä¸ºï¼ˆä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºä¾‹ï¼‰

- æµ‹è¯•ç±»ExtensionMethodTeståŠ è½½ï¼Œæ‰§è¡Œè¢«@BeforeAllæ³¨è§£çš„é™æ€æ–¹æ³•
- æµ‹è¯•ç±»åˆ›å»ºï¼šExtensionMethodTestã€åµŒå¥—ç±»FillWith
- æ‰§è¡Œ@BeforeEachæ³¨è§£çš„æ–¹æ³•
- æ‰§è¡Œ@Testæˆ–@ParameterizedTestæ³¨è§£çš„æ–¹æ³•
- æ‰§è¡Œ@AfterEachæ³¨è§£çš„æ–¹æ³•
- æµ‹è¯•ç±»è¢«ä¸¢å¼ƒ
- æ‰§è¡Œå¦ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ—¶ï¼Œä»ç¬¬äºŒæ­¥å¼€å§‹å†æ‰§è¡Œ
- æ‰§è¡Œè¢«@AfterAllæ³¨è§£çš„é™æ€æ–¹æ³•

æ‰€ä»¥é‡ç‚¹æ˜¯

- æ‰§è¡Œæ¯ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œéƒ½ä¼šé‡æ–°åˆ›å»ºæµ‹è¯•ç±»å®ä¾‹ã€‚è€Œä¸æ˜¯å¤šä¸ªæµ‹è¯•æ–¹æ³•å…±ç”¨ä¸€ä¸ªå®ä¾‹
- åŸºäºä¸Šé¢çš„åŸå› ï¼Œ@BeforeAllã€@AfterAllæ³¨è§£çš„æ–¹æ³•åªèƒ½åœ¨ç±»åŠ è½½æœŸé—´æ‰§è¡Œï¼Œå³åªèƒ½æ³¨è§£åˆ°é™æ€æ–¹æ³•ä¸Šã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆéé™æ€åµŒå¥—ç±»ä¸­æ— æ³•ä½¿ç”¨@BeforeAllï¼Œå› ä¸ºå®ƒæ— æ³•å®šä¹‰é™æ€æ–¹æ³•å‘€

> ç†è§£å•å…ƒæµ‹è¯•ï¼šå•å…ƒæµ‹è¯•çš„åŸºæœ¬è¦æ±‚ä¹‹ä¸€æ˜¯æµ‹è¯•caseä¹‹é—´ç›¸äº’ä¸å½±å“ï¼Œæµ‹è¯•æ–¹æ³•å¯èƒ½ä½¿ç”¨äº†æµ‹è¯•ç±»ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¸ºäº†ä¿è¯ä¸å—å…¶å®ƒä½¿ç”¨è¯¥å˜é‡çš„æµ‹è¯•æ–¹æ³•çš„å½±å“ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯ä¸ºè¯¥æ–¹æ³•ä¸“é—¨åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±»å®ä¾‹ã€‚è¿™å°±æ˜¯JUnitçš„é»˜è®¤è¡Œä¸ºï¼Œä¸€å®šè¦ç†è§£ã€‚
>
> ä¹Ÿååˆ†æ¨èè¿™ä¹ˆåšï¼Œè¿™æ‰æ˜¯çœŸçš„å•å…ƒæµ‹è¯•ã€‚
>
> å¯¹äºé‚£äº›å¤šä¸ªæµ‹è¯•æ–¹æ³•ç¡®å®éœ€è¦å…±äº«ä¸€ä¸ªæµ‹è¯•ç±»å®ä¾‹çš„æƒ…å†µï¼ŒJUnitä¹Ÿæä¾›æ”¯æŒã€‚ä½¿ç”¨æ—¶è¦æ…é‡ï¼Œæ­¤æ—¶@BeforeAllçš„è¡Œä¸ºä¹Ÿä¼šæ”¹å˜ã€‚
>
> ```kotlin
> @TestInstance(Lifecycle.PER_CLASS)
> class ExtensionMethodTest {
> ```

## åµŒå¥—ç±»

JUnitæä¾›åµŒå¥—ç±»çš„æ”¯æŒï¼Œæ˜¯ä¸ºäº†æä¾›ç»™ç”¨æˆ·æ›´å¥½çš„æµ‹è¯•ä¹‹é—´ç»„å…³ç³»çš„æ”¯æŒã€‚

ä¸Šä¾‹ä¸­ï¼Œå¯¹æ¯ä¸ªå¾…æµ‹æ–¹æ³•ï¼Œéƒ½æœ‰å¤šä¸ªcaseéœ€è¦æ‰§è¡Œï¼Œä¸ºäº†å°†äºŒè€…åˆ†ä¸ºä¸¤ç»„ï¼Œæˆ‘ä¸ºæ¯ä¸ªå¾…æµ‹æ–¹æ³•å»ºç«‹äº†ä¸€ä¸ªåµŒå¥—å¯¹è±¡ï¼Œæµ‹è¯•caseä½œä¸ºåµŒå¥—å¯¹è±¡çš„æ–¹æ³•ï¼Œè¿™æ ·åœ¨åµŒå¥—ç±»ä¸Šæ·»åŠ å…¬å…±çš„è¯´æ˜ï¼Œå¾—åˆ°çš„æµ‹è¯•æŠ¥å‘Šä¹Ÿæ›´åŠ å±‚æ¬¡åŒ–ã€‚

![image-20220226182218073](https://gdz.oss-cn-shenzhen.aliyuncs.com/local/image-20220226182218073.png)

å¯ä»¥æƒ³è§ï¼Œå¦‚æœæ²¡æœ‰è¿™æ ·çš„æ”¯æŒï¼Œæˆ‘éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•çš„æ˜¾ç¤ºåä¸­åŠ ä¸Šè¯´æ˜ï¼Œå¤šä¹ˆéº»çƒ¦ã€‚

## å‚æ•°åŒ–æµ‹è¯•

åˆ©å™¨ä¹‹äºŒï¼Œæœ€å…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯é’ˆå¯¹å„ç§ä¸åŒè¾“å…¥çš„æµ‹è¯•ï¼Œå‚è€ƒä¸Šä¾‹`ExtensionMethodTest.ParseOssObjectKey.just test()`ï¼Œç‰¹ç‚¹

- ä½¿ç”¨æ³¨è§£@ParameterizedTestï¼Œå¯ä»¥é€šè¿‡nameæŒ‡å®šæµ‹è¯•åç§°ã€‚nameæŒ‡å®šçš„å­—ç¬¦ä¸²ä¸­æœ‰å‡ ä¸ªå¯ä»¥ä½¿ç”¨çš„å ä½ç¬¦

  | Placeholder            | Description                                                  |
  | :--------------------- | :----------------------------------------------------------- |
  | `{displayName}`        | æ–¹æ³•çš„åç§°                                                   |
  | `{index}`              | å½“å‰è°ƒç”¨çš„å‚æ•°åœ¨å‚æ•°åˆ—è¡¨ä¸­çš„ç´¢å¼•                             |
  | `{arguments}`          | å®Œæ•´çš„æµ‹è¯•æ–¹æ³•å‚æ•°å€¼ï¼Œé€—å·åˆ†éš”                               |
  | `{argumentsWithNames}` | å®Œæ•´çš„æµ‹è¯•æ–¹æ³•çš„å‚æ•°åå’Œå‚æ•°å€¼ï¼Œæ ¼å¼ key1=value1,key2=value2... |
  | `{0}`, `{1}`, â€¦        | å…·ä½“çš„å‚æ•°                                                   |

- æœ‰å®šä¹‰çš„ç°æˆåç§°å¯ä»¥ä½¿ç”¨ï¼Œå¦‚ï¼š`ParameterizedTest#DISPLAY_NAME_PLACEHOLDER`

- å¿…é¡»å’Œæ•°æ®æºæ³¨è§£ä¸€èµ·ä½¿ç”¨ï¼Œæ”¯æŒçš„æ³¨è§£æºï¼ˆå¯ä»¥å åŠ ä½¿ç”¨ï¼‰

  - @ValueSourceï¼šæœ€å¸¸ç”¨ï¼Œå•ä¸ªå€¼çš„åˆ—è¡¨

  - @NullAndEmptySourceã€@NullSourceã€‚ã€‚ã€‚ï¼šæœ€å¸¸ç”¨ï¼Œnullæˆ–ç©ºä¸²

  - @EnumSource

  - @MethodSourceï¼šæ•°æ®æ¥æºäºä¸€ä¸ªæ–¹æ³•

    ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼Œé‡ç‚¹æ˜¯æ–¹æ³•è¦æ˜¯é™æ€çš„ï¼ˆé™¤éLifeCycle.PER_CLASSï¼‰ï¼›è¿”å›Argumentsçš„é›†åˆç±»å‹

    ```kotlin
    		// å®šä¹‰
        @JvmStatic
        fun provideLegalResource(): List<Arguments> {
            return PathMatchingResourcePatternResolver().getResources(LEGAL_RESOURCE_PATTERN).map { resource ->
                resource.file.name to publicObjectMapper.readTree(resource.file)
            }.map { (fileName, mockResources) ->
                mockResources.map { mockResource ->
                    val resourceType = fileName.removeSuffix(RESOURCE_FILE_SUFFIX)
                    val comment = (mockResource as ObjectNode).remove(COMMENT_KEY).asText()
                    val content = """{"resources": [${mockResource.toJsonString()}]}"""
                    // ä¸Šé¢éƒ½å¿½ç•¥ï¼Œè¿™æ‰æ˜¯å…³é”®
                    Arguments.of(resourceType, comment, content)
                }
            }.flatten()
        }
    
    		// ä½¿ç”¨
        @ParameterizedTest(name = "{displayName} {argumentsWithNames}")
        @MethodSource("xxx.ResourceProvider#provideLegalResource")
        fun `200 when legal resource`(type: String, comment: String, content: String) {
    ```

  - @CsvSourceï¼šä»¥CSVçš„æ–¹å¼æä¾›å¤šä¸ªå€¼

  - @CsvFileSource

  - @ArgumentsSourceï¼šæ•°æ®æºäºä¸€ä¸ªArgumentsProviderï¼Œè¿™ä¸ªå…¶å®æ˜¯æœ€é€šç”¨çš„æ–¹æ³•ï¼Œä¸Šé¢çš„æ‰€æœ‰æ³¨è§£éƒ½æ˜¯ç”¨ArgumentsProviderå®ç°çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ª

    ```java
    @ArgumentsSource(NullArgumentsProvider.class)
    public @interface NullSource {
    }
    ```

## æ„é€ å™¨å’Œæ–¹æ³•çš„æ³¨å…¥

æ³¨æ„ä¸Šé¢çš„beforeEach()æ–¹æ³•çš„å‚æ•°TestInfoï¼Œä¹‹æ‰€ä»¥æ–¹æ³•æ‰§è¡Œæ—¶èƒ½å¤Ÿè·å¾—è¿™ä¸ªå‚æ•°ï¼Œæ˜¯å› ä¸ºJUnitæ‰§è¡Œäº†æ³¨å…¥æ“ä½œã€‚

JUnitæ”¯æŒå‘æµ‹è¯•ç±»çš„æ„é€ å™¨å’Œæ‰€æœ‰æˆå‘˜æ–¹æ³•æ‰§è¡Œæ³¨å…¥æ“ä½œï¼Œå¯¹åº”çš„APIæ˜¯`ParameterResolver`ã€‚é»˜è®¤å®ç°æœ‰ä¸‰ä¸ªï¼Œæœ‰éœ€è¦å¯ä»¥è‡ªå·±å¢åŠ 

- `TestInfoParameterResolver`
- `RepetitionInfoParameterResolver`
- `TestReporterParameterResolver`

## æµ‹è¯•çš„ç»§æ‰¿

å¦‚æœæœ‰å¤šä¸ªç±»éƒ½æœ‰ç›¸åŒçš„æµ‹è¯•å‰ç½®æ“ä½œã€æµ‹è¯•caseï¼Œå¯ä»¥å°†è¿™äº›å†…å®¹æŠ½å–æˆä¸ºä¸€ä¸ªæ¥å£ã€‚JUnitçš„æ³¨è§£æ•ˆæœæ˜¯å¯ä»¥ç»§æ‰¿çš„ï¼Œè¿™æ˜¯ä¸ªåˆ©å™¨ã€‚åˆç†ä½¿ç”¨ã€‚

ä¸¾ä¾‹ï¼šcontrollerå±‚çš„å•å…ƒæµ‹è¯•ä¸­ï¼Œæ¥å£é‰´æƒæ˜¯å…¬å…±çš„caseï¼Œå°±å¾ˆé€‚åˆæŠ½å‡ºæ¥ï¼Œæ¯ä¸ªæ¥å£éƒ½å®ç°å®ƒã€‚

> æ›´å¤šå†…å®¹è¯·å‚è€ƒJUnitç”¨æˆ·æ‰‹å†Œï¼Œå€¼å¾—æ¢ç©¶çš„å†…å®¹
>
> - æµ‹è¯•é¡ºåº
>
>   æµ‹è¯•æ–¹æ³•ä¹‹é—´é»˜è®¤æ²¡æœ‰é¡ºåºï¼Œä½†å¯é€šè¿‡æ·»åŠ @Orderçš„æ–¹å¼å£°æ˜é¡ºåº
>
> - å¹¶è¡Œæ‰§è¡Œ
>
>   JUnité»˜è®¤ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå¤šä¸ªä»¥æå‡æµ‹è¯•æ‰§è¡Œé€Ÿåº¦ï¼Œä¸è¿‡è¦æ³¨æ„å¹¶å‘é—®é¢˜
>
> - æ¡ä»¶æµ‹è¯•
>
>   æµ‹è¯•caseåœ¨æ¡ä»¶æ»¡è¶³çš„æƒ…å†µä¸‹æ‰æ‰§è¡Œ
>
> - æµ‹è¯•æ¨¡æ¿å’ŒåŠ¨æ€æµ‹è¯•
>
>   å½“éœ€è¦åŠ¨æ€ç”Ÿæˆæµ‹è¯•æ–¹æ³•æ—¶ï¼Œä¸å¦¨è€ƒè™‘è€ƒè™‘å®ƒä»¬

# Mockk

å•å…ƒæµ‹è¯•ä¸åƒé›†æˆæµ‹è¯•ï¼Œâ€å•å…ƒâ€œäºŒå­—æ˜¯å…³é”®ï¼Œä¸€æ¬¡åªæµ‹è¯•å•ä¸ªé€»è¾‘ã€‚å…¶å®ƒçº§è”çš„æ–¹æ³•è°ƒç”¨ï¼Œéƒ½å¯ä»¥é€šè¿‡mockè§£å†³ã€‚ä¸ä¹‹å¯¹åº”çš„ä¸¤ä¸ªæ¦‚å¿µ

- mockï¼šå®Œå…¨ä¼ªé€ ç›®æ ‡ï¼Œç›®æ ‡å¯ä»¥æ˜¯å¯¹è±¡ã€é™æ€æ–¹æ³•ã€kotlinçš„objectç­‰
- spyï¼šåœ¨ç°æœ‰çš„ç›®æ ‡ä¸Šè¿›è¡Œmock

å¦‚æœç”¨Kotlinï¼Œmockkä¸€å®šæ˜¯ä¸ªå¾ˆå¥½çš„å°è¯•ã€‚ç›¸å¯¹äºMockitoï¼ŒMockKåŠŸèƒ½å…¨é¢ï¼Œæ”¯æŒDSLï¼Œä¹¦å†™æµç•…ç®€å•ã€‚ä¸‹é¢é€šè¿‡ä¸€äº›åœºæ™¯ä»‹ç»ã€‚

## åŸºæœ¬ä½¿ç”¨æ–¹æ³•

MockKçš„å®Œæ•´ä½¿ç”¨æ–¹æ³•åŒ…æ‹¬

- å£°æ˜mockå¯¹è±¡
- mockå¯¹è±¡çš„è¡Œä¸º
- æ‰§è¡Œè¢«æµ‹æ–¹æ³•
- éªŒè¯ç»“æœã€è¡Œä¸ºã€è¿‡ç¨‹å‚æ•°

å¦‚æœä½¿ç”¨JUnit5ï¼ŒMockKæä¾›MockkExtensionï¼ŒåŒMockitoExtensionï¼ŒMockitoä¸­å¯¹åº”çš„@Mockã€@Spyã€@InjectMocksåˆ†åˆ«å˜æˆ@MockKã€@SpyKã€@InjectMockKsã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­

```kotlin
@ExtendWith(MockKExtension::class)
class MediaServiceTest {

  // å£°æ˜mockå¯¹è±¡
  @MockK
  private lateinit var miscService: MiscService

  // å£°æ˜spyå¯¹è±¡ï¼ŒåŒæ—¶å£°æ˜spyçš„å…·ä½“å¯¹è±¡ï¼šmockMediaProperties
  @SpyK
  private var mediaProperties: MediaProperties = mockMediaProperties

  // å£°æ˜è¢«æµ‹å¯¹è±¡ï¼ŒmediaServiceä¼šè¢«åˆ›å»ºï¼Œå¹¶ä½¿ç”¨miscServiceå’ŒmediaPropertiesæ³¨å…¥å…¶æ„é€ æ–¹æ³•
  @InjectMockKs
  private lateinit var mediaService: MediaService

  @Test
  fun `test`() {
    val mockUser = MOCK_USER_ID
    val mockDir = "mockDir"
    // ä¸´æ—¶å£°æ˜çš„mockå¯¹è±¡ï¼ŒGetOssDirMetaRespç±»çš„å¯¹è±¡
    val mockOssDirMetaResp = mockk<GetOssDirMetaResp>()
    val mockDirMeta = mockk<GetOssDirMetaResp.DirMeta>()
    // ä¸´æ—¶åˆ›å»ºspyå¯¹è±¡ï¼ŒåŸºäºè¢«æµ‹å¯¹è±¡mediaServiceåˆ›å»ºï¼Œç›®æ ‡æ˜¯mockè¢«æµ‹å¯¹è±¡çš„è¡Œä¸º
    val spyMediaService = spyk(mediaService)
    // mockè¡Œä¸º
    every { spyMediaService.parseDir(any()) } returns mockDir
    every { spyMediaService.mediaStub.getOssDirMeta(any()) } returns mockOssDirMetaResp
    every { mockOssDirMetaResp.dirMetaList } returns listOf(mockDirMeta)
    every { mockDirMeta.totalSize } returns 0
		// è°ƒç”¨è¢«æµ‹æ–¹æ³•
    spyMediaService.getOccupiedSpaceOfUser(mockUser)

    val slot = slot<GetOssDirMetaReq>()
    // æ•è·spyMediaService.mediaStub.getOssDirMeta()çš„å‚æ•°
    verify { spyMediaService.mediaStub.getOssDirMeta(capture(slot)) }
    // éªŒè¯æ•è·åˆ°çš„å‚æ•°
    assertThat(slot.captured.app).isEqualTo(mediaProperties.appId)
    assertThat(slot.captured.getDir(0)).isEqualTo(mockDir)
  }
}
```

è§£é‡Š

- miscServiceéœ€è¦å‡­ç©ºmockï¼ŒmediaPropertieséœ€è¦åœ¨æä¾›çš„å¯¹è±¡åŸºç¡€ä¸Šmock
- mediaServiceçš„åˆ›å»ºä¾èµ–äºmiscServiceå’ŒmediaProperties

- é™¤äº†MockKExtensionï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨`MockKAnnotations.init(this::class)`æ¥ä½¿å…¶ç”Ÿæ•ˆ
- æœ¬ä¾‹æµ‹è¯•çš„æ˜¯æŸä¸ªå‚æ•°ï¼Œä½¿ç”¨slot()æ–¹æ³•æŠ“å–è¯¥å‚æ•°

## é»˜è®¤è¡Œä¸º

Mockitoä¸­ï¼Œå¦‚æœä¸å¯¹mockå¯¹è±¡çš„è¡Œä¸ºåšé¢„è®¾ï¼Œè¡Œä¸ºé»˜è®¤è¿”å›å¯¹åº”è¿”å›ç±»å‹çš„ç©ºå€¼ã€‚MockKç•¥æœ‰ä¸åŒï¼Œä¸æä¾›é»˜è®¤è¡Œä¸ºçš„mockï¼Œä½†å¯æ‰‹åŠ¨é€‰æ‹©å¼€å¯ã€‚

- @RelaxedMockK : å¤‡æ³¨æ¥çš„å¯¹è±¡å¸¦æœ‰é»˜è®¤å€¼
- @MockK(relaxed = true)ï¼šåŒä¸Š
- mockk\<MyObject>(relaxed = true)ï¼šæ‰‹åŠ¨mockå‡ºæ¥çš„MyObjectå¯¹è±¡è¡Œä¸ºå¸¦æœ‰é»˜è®¤å€¼

## mockå•ä¾‹å¯¹è±¡

```kotlin
object RequestContext {
	val currentUser: Int = 12
}

@Test
fun test() {
  mockkObject(RequestContext)
  every { RequestContext.currentUser } returns 1
  println(RequestContext.currentUser) // è¾“å‡º1
}
```

> å€¼å¾—ä¸€æçš„æ˜¯ï¼Œmockæšä¸¾å¯¹è±¡ä¹Ÿæ˜¯é€šè¿‡mockkObjectå®Œæˆï¼Œæ¯•ç«Ÿï¼Œæ¯ä¸ªæšä¸¾é¡¹å°±æ˜¯ä¸€ä¸ªå•ä¾‹ã€‚

## mocké™æ€æ–¹æ³•

```kotlin
object RequestContext {
  @JvmStatic
  fun getUserId() = userIdTL.get()
}

@Test
fun test() {
  mockkStatic(RequestContext::getUserId)
  every { RequestContext.getUserId() } returns 1
  println(RequestContext.getUserId()) // è¾“å‡º1
}
```

## mockæ„é€ æ–¹æ³•

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªï¼ŒMembershipLevelStrategySelectoråˆ›å»ºï¼Œç„¶åè°ƒç”¨select()æ–¹æ³•ï¼Œæˆ‘æƒ³è¦mock select()æ–¹æ³•çš„è¡Œä¸ºï¼Œå°±è¦mockMembershipLevelStrategySelectorçš„æ„é€ æ–¹æ³•

```kotlin
fun doRedeem(currentUser: Int, currentAward: InvitationAwardModel) {
  ... ...
  MembershipLevelStrategySelector(existSubscription, addPrivilegedBo).select().handle()
  ... ...
}
```

äºæ˜¯mockè¿™æ ·å†™

```kotlin
mockkConstructor(MembershipLevelStrategySelector::class)
every { anyConstructed<MembershipLevelStrategySelector>().select() } returns mockk<AddPrivilegedStrategy>(relaxed = true)
```

## ä¸SpringBooté›†æˆ

æœ‰[springmock](https://github.com/Ninja-Squad/springmockk)é¡¹ç›®ä¸ºMockKé›†æˆåˆ°SpringBootä¸­æä¾›æ”¯æŒï¼Œä¸»è¦æ˜¯æ”¯æŒ@MockKBeanæ³¨è§£å•¦ã€‚

## å…¶å®ƒ

è¿˜æœ‰åŠŸèƒ½å¦‚ä¸‹ï¼Œä¸å†è¯¦è¿°ï¼Œè¯¦æƒ…å‚è€ƒ[å®˜æ–¹æ‰‹å†Œ](https://mockk.io/)

- mocké“¾å¼è°ƒç”¨ï¼Œå³ä¸€æ¬¡æ€§mock`a.method1().method2()`ï¼Œè€Œä¸éœ€è¦å•ç‹¬mock
- å¸¦æœ‰å±‚æ¬¡ç»“æ„çš„mock
- å¸¦æœ‰é¡ºåºçš„verify
- verifyæŸä¸ªæ–¹æ³•æœªè¢«è°ƒç”¨ï¼ˆå¾ˆæœ‰ç”¨ï¼‰
- è‡ªå®šä¹‰answerç­‰

# AssertK

ä¸AssertJå¯¹åº”çš„ï¼Œæ˜¯AssertKã€‚ä¸‹é¢å±•ç¤ºç®€å•ç”¨æ³•ï¼Œå…·ä½“å‚è€ƒ[å®˜æ–¹æ‰‹å†Œ](https://github.com/willowtreeapps/assertk)

## å¸¸è§„

```kotlin
assertThat(person.name).isEqualTo("Hello")
assertThat(person.age, "age").isGreaterThan(20) // ageæ˜¯æŠ¥é”™æ—¶çš„æ˜¾ç¤ºå
assertThat(nullString).isNotNull().hasLength(4) // å¯ç©ºåˆ¤æ–­å’Œå­—ç¬¦ä¸²åˆ¤æ–­
assertThat(string).all {
    startsWith("L")
    hasLength(3)
} // å¤šä¸ªåŒæ—¶åˆ¤æ–­
assertAll {
    assertThat(false).isTrue()
    assertThat(true).isFalse()
} // æ›´é€šç”¨çš„å¤šä¸ªåŒæ—¶åˆ¤æ–­
```

## é”™è¯¯åˆ¤æ–­

```kotlin
assertThat { throw Exception("error") }.isFailure().hasMessage("wrong")
assertThat { throw Exception("error") }.isFailure().matchPreticate {
  // è‡ªå·±çš„åˆ¤æ–­
}
```

> ä¸ªäººè®¤ä¸ºæ–­è¨€åº“çš„ä¸¤ä¸ªå…³é”®ç‚¹æ˜¯ä½¿ç”¨çš„ç®€å•æ€§å’ŒæŠ¥é”™ä¿¡æ¯çš„å±•ç¤ºï¼ŒAssertKåšçš„éƒ½è¿˜ä¸é”™ã€‚
>
> å¦‚æœè§‰å¾—ä¸å¤Ÿç”¨ï¼Œä¹Ÿæœ‰è‡ªå®šä¹‰æ–­è¨€å¯é€‰ã€‚

# Spring Boot Test

SpringBootçš„testæ¨¡å—ï¼Œé»˜è®¤åŒ…å«çš„æµ‹è¯•å·¥å…·JUnit5ã€Mockitoã€AssertJã€‚ç›¸å¯¹äºæ­¤ï¼Œé¢å¤–çš„åŠŸèƒ½æ˜¯æä¾›Springä¸Šä¸‹æ–‡ã€‚

## @SpringBootTest

åœ¨æµ‹è¯•ç±»ä¸Šæ·»åŠ æ­¤æ³¨è§£æ˜¯æœ€ä¸ºç®€å•çš„æ–¹å¼ã€‚å®ƒåšäº†å¦‚ä¸‹å‡ ä»¶äº‹

- é€šè¿‡SpringApplicationåˆ›å»ºApplicationContext

- é»˜è®¤æƒ…å†µä¸‹å®ƒä¸ä¼šå¯åŠ¨serverã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡webEnvironmentæŒ‡å®šç¯å¢ƒï¼Œé»˜è®¤ä¸ºMOCK

  - MOCKï¼šåˆ›å»ºä¸€ä¸ªwebç±»å‹çš„ApplicationContextã€ä¸€ä¸ªwebç±»å‹çš„Environmentã€‚SpringBootå†…åµŒçš„Serverä¸ä¼šå¯åŠ¨ã€‚å¦‚æœç±»è·¯å¾„ä¸­æ²¡æœ‰webç›¸å…³çš„ç±»å¯æä¾›ã€‚åˆ™å›æ»šåˆ›å»ºä¸€ä¸ªéwebçš„ApplicationContextã€‚

    å¯ä»¥ç»“åˆ@AutoConfigureMockMvcå’Œ@AutoConfigWebTestClientä½¿ç”¨ã€‚å‰è€…æä¾›ä¸€ä¸ªæœåŠ¡mockï¼Œåè€…æä¾›ä¸€ä¸ªå®¢æˆ·ç«¯mockç»ˆç«¯

  - RANDOM_PORTï¼šåˆ›å»ºWebApplicationContextï¼Œåˆ›å»ºçœŸå®çš„Serverï¼Œå†…åµŒServerè¢«å¯åŠ¨ï¼Œç«¯å£éšæœº

  - DEFINED_PORTï¼šåŒä¸Šï¼Œåªä¸è¿‡ç«¯å£è·Ÿéšé…ç½®æ–‡ä»¶

  - NONEï¼šåˆ›å»ºæ™®é€šçš„ApplicationContext

- å½“Spring MVCã€Spring Webfluxä»»ä½•ä¸€ä¸ªè¢«æ£€æµ‹åˆ°ï¼Œå°±åˆ›å»ºå¯¹åº”çš„webç¯å¢ƒã€‚å¦‚æœéƒ½å­˜åœ¨ï¼Œåˆ™åˆ›å»ºMVCç¯å¢ƒã€‚æ­¤æ—¶æƒ³è¦ä½¿ç”¨webfluxï¼Œåªèƒ½@SpringBootTest(properties = "spring.main.web-application-type=reactive")

å¯è§ï¼Œ@SpringBootTestéå¸¸é‡ï¼Œä¼šæ‰«æå¹¶åŠ è½½æ‰€æœ‰Beanã€‚ä½†å®é™…æˆ‘ä»¬å¾€å¾€åªä¼šæµ‹è¯•ä¸€éƒ¨åˆ†å†…å®¹ï¼Œå¯¹æ­¤Springæä¾›äº†éƒ¨åˆ†è£…è½½çš„åŠŸèƒ½ï¼Œç›¸å½“äº@SpringBootTestçš„å­é›†ã€‚å®ƒåŸºäºSpringçš„è‡ªåŠ¨é…ç½®æœºåˆ¶ï¼Œç°æœ‰æ”¯æŒå¯åœ¨[è¿™é‡ŒæŸ¥çœ‹](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing.spring-boot-applications.autoconfigured-tests)ã€‚

ä¾æ®å®é™…ä½¿ç”¨çš„ç»éªŒï¼ŒSpringæä¾›çš„æµ‹è¯•æœºåˆ¶å¹¶ä¸å‹å¥½ï¼Œå¾€å¾€è¿‡äºå¤æ‚ï¼Œæ‰€ä»¥èƒ½ä¸ç”¨å°±ä¸ç”¨ã€‚ç›¸åï¼Œå®ƒæ›´é€‚åˆé›†æˆæµ‹è¯•æ—¶ä½¿ç”¨ï¼Œè€Œä¸æ˜¯å•å…ƒæµ‹è¯•ã€‚

## @MockBeanå’Œ@SpyBean

è¢«æ­¤äºŒè€…æ³¨è§£çš„å±æ€§ï¼Œä¼šä½¿ç”¨Mockitoç”Ÿæˆä¸€ä¸ªmockå¯¹è±¡ï¼Œç„¶åæ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œå…¶ä»–åœ°æ–¹å¯ä»¥è‡ªç”±æ³¨å…¥ã€‚ä»¥@MockBeanä¸ºä¾‹ï¼Œå®ƒæœ‰å¦‚ä¸‹ç‰¹æ€§

- ä½¿ç”¨@SpringBootTestæ—¶ï¼Œè¯¥åŠŸèƒ½é»˜è®¤å¼€å¯ã€‚å…¶å®ƒæƒ…å†µä½¿ç”¨æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ã€‚æ·»åŠ ä¸¤ä¸ªç›‘å¬å™¨

  ```kotlin
  @ContextConfiguration(classes = MyConfig.class)
  @TestExecutionListeners({ MockitoTestExecutionListener.class, ResetMocksTestExecutionListener.class })
  class MyTests 
  ```

- å®ƒå®šä¹‰çš„æ˜¯Mockitoçš„Mock

- æ¯ä¸ªtestæ–¹æ³•ç»“æŸåï¼Œè¢«Mockçš„Beanä¼šè¢«reset

- ä¾‹å­å¦‚ä¸‹ï¼šReverserä½¿ç”¨çœŸå®å¯¹è±¡ï¼›RemoteServiceä½¿ç”¨Mockå‡ºæ¥çš„Bean(è¦†ç›–åŸå¯¹è±¡ä¸­çš„Bean)

  ```kotlin
  @SpringBootTest
  class MyTests {
  
    @Autowired
    private Reverser reverser;
  
    @MockBean
    private RemoteService remoteService;
  
    @Test
    void exampleTest() {
      given(this.remoteService.getValue()).willReturn("spring");
      String reverse = this.reverser.getReverseValue(); // Calls injected RemoteService
      assertThat(reverse).isEqualTo("gnirps");
    }
  
  }
  ```

> å‰æ–‡è¯´è¿‡ï¼Œä½¿ç”¨MockKåï¼Œæ¢æˆ@MockKBeanï¼Œç”±springmockåº“æä¾›æ”¯æŒ

## MockMvc

MockMvcæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œä¸ä¹‹ç›¸å¯¹çš„ï¼Œæ˜¯ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆå³æœåŠ¡å¯åŠ¨ï¼Œç„¶åä½¿ç”¨å®¢æˆ·ç«¯æ‰‹åŠ¨è®¿é—®ï¼‰ã€‚ä½¿ç”¨å®ƒèƒ½å¤Ÿå¾ˆå¥½æ»´å¯¹Spring MVCæ„å»ºçš„ç«¯ç‚¹è¿›è¡Œæµ‹è¯•ï¼ŒåŒæ—¶æ”¯æŒKotlin DSLï¼Œä¸€ä¸ªç®€å•çš„ä¾‹å­

```kotlin
@ControllerTest(SyncController::class)
class SyncControllerTest {
  @Autowired
  private lateinit var mockMvc: MockMvc

  @MockkBean
  private lateinit var resourceService: ResourceService

  @Test
  fun `test`() {
    mockMvc.post("/v2/resources/push") {
      contentType = MediaType.APPLICATION_JSON
      content = PushReqV2Dto().apply { resources = null }.toJsonString()
    }.andExpect {
      status {
        isBadRequest()
      }
      header {
        exists("TOKEN")
      }
      content {
        contentType(MediaType.APPLICATION_JSON)
      }
    }
  }
}
```

DSLçš„ä½¿ç”¨ä¹Ÿç›¸å½“ç®€å•ï¼Œæ•´ä½“è€Œè¨€åŒ…æ‹¬ä¸¤ä¸ª

- å¡«å……è¯·æ±‚å‚æ•°
  - è¯·æ±‚æ–¹å¼ï¼šgetã€postï¼Œæˆ–è€…ä¸­æ€§çš„perform
  - è¯·æ±‚è·¯å¾„
  - è¯·æ±‚å‚æ•°ï¼šå¤´éƒ¨ã€å‚æ•°ã€body
- å¡«å……é¢„æœŸå†…å®¹
  - çŠ¶æ€ç 
  - å“åº”ç»“æœï¼šå¤´éƒ¨ã€bodyç­‰

é€šè¿‡ä»£ç æç¤ºï¼Œä¹Ÿèƒ½çŸ¥é“ï¼Œæœ‰ä¸‰ç§ç±»å‹çš„APIè°ƒç”¨

- andReturn()ï¼šè¿”å›æ‰§è¡Œç»“æœï¼Œä»¥MvcResultå°è£…
- andExpect{}ï¼šDSLï¼Œå¡«å……ä¸€äº›æ–­è¨€
- andDo{}ï¼šDSLï¼Œè¿™é‡Œå¯ä»¥åšä¸€äº›ä¸­æ€§çš„å®è¡Œï¼Œæ¯”å¦‚æ‰“å°å‡ºå“åº”ç»“æœã€‚

![image-20220305125110742](https://gdz.oss-cn-shenzhen.aliyuncs.com/local/image-20220305125110742.png)

> è¿™æ˜¯Springæ„å»ºçš„Webåº”ç”¨çš„æµ‹è¯•åˆ©å™¨
>
> ä½†æ­£å¦‚[Springæ‰‹å†Œ](https://docs.spring.io/spring-framework/docs/5.3.16/reference/html/testing.html#spring-mvc-test-framework)æ‰€åˆ†ç±»çš„é‚£æ ·ï¼Œå…¶å®è¿™ç©æ„å„¿è¢«åˆ†ç±»åœ¨é›†æˆæµ‹è¯•çš„
>
> <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/local/image-20220305125736965.png" alt="image-20220305125736965" style="zoom:80%;" />

# ä¸€ç‚¹æƒ³æ³•

æƒ³æ³•1ï¼šçœ¼é«˜æ‰‹ä½ã€‚æ”¶é›†èµ„æ–™æ—¶æƒ³ç€æœ‰å¥½å¤šä¸œè¥¿å¯ä»¥å†™ï¼›å†™çš„æ—¶å€™åˆå‘ç°å¦‚æœè¦æŠŠé‚£äº›éƒ½å†™å®Œï¼Œè¡ç”Ÿå‡ºæ¥çš„çŸ¥è¯†å¤ªå¤šäº†ï¼Œæ ¹æœ¬æ— æš‡é¡¾åŠã€‚äºæ˜¯æ‹–å»¶ï¼Œä½†ä¸€æƒ³ä¸è¡Œï¼Œè¦ç»§ç»­å†™å‘€ï¼Œäºæ˜¯ä¸€å‡å†å‡ï¼Œæˆäº†ç°åœ¨çœ‹åˆ°çš„è¿™ä¸ªæ ·å­ï¼Œä¸ç”šæ»¡æ„ã€‚ä½†æ€»å¥½è¿‡æ²¡æœ‰ã€‚

æƒ³æ³•2ï¼šå†™è¿™ç±»å­¦ä¹ çš„æ–‡ç« ï¼Œè¿˜æ˜¯è¦è¶æ–°é²œã€‚ä¸€äº›å†…å®¹ï¼Œåˆšçœ‹åˆ°æ—¶ä¼šæœ‰æƒŠè‰³çš„æ„Ÿè§‰ï¼Œè§‰å¾—å€¼å¾—ä¸€å†™ã€‚ä¹ æƒ¯ä¹‹ååˆè§‰å¾—ç†æ‰€å½“ç„¶ï¼Œæœ‰ä»€ä¹ˆå¥½å†™çš„ã€‚æ®Šä¸çŸ¥ï¼Œæ•°æœˆåï¼Œå¯¹é‚£äº›è®¤ä¸ºç†æ‰€å½“ç„¶çš„å†…å®¹ï¼Œæˆ‘åˆæ¢å¤æˆèŒæ–°çš„çŠ¶æ€ã€‚åˆè¦ä»å¤´å¼€å§‹å­¦ä¹ ï¼Œåˆ°æ—¶è¿ä¸ªå›é¡¾çš„çº²è¦éƒ½æ²¡æœ‰ã€‚æˆ–è®¸ä»å¦ä¸€é¢è¯æ˜äº†ï¼šå†™è¿™ç©æ„å„¿ï¼Œå«åšæ²‰æ·€ğŸ¤”

# å‚è€ƒæ–‡æ¡£

- [TestNG ä¸ Junit å¯¹æ¯”ï¼Œæµ‹è¯•æ¡†æ¶å¦‚ä½•é€‰æ‹©ï¼Ÿ](https://zhuanlan.zhihu.com/p/101905583)

- [JUnitç”¨æˆ·æ‰‹å†Œ](https://junit.org/junit5/docs/current/user-guide/)

- [MockKç”¨æˆ·æ‰‹å†Œ](https://mockk.io/)
- [springmockkä¸»é¡µ](https://github.com/Ninja-Squad/springmockk)

- [AssertKä¸»é¡µ](https://github.com/willowtreeapps/assertk)
- [Spring Boot Test](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html)
- [Spring Test](https://docs.spring.io/spring-framework/docs/5.3.16/reference/html/testing.html#unit-testing)
