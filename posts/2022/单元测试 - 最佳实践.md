---
created_at: 2022-03-06 13:13:35
updated_at: 2022-03-06 13:13:35
slug: java-unit-test-best-practice
tags:
  - å•å…ƒæµ‹è¯•
---

> æ˜¯ä¸æ˜¯æœ€ä½³ä¸çŸ¥é“ï¼Œåæ­£å®ƒæ˜¯ä¸ªå®è·µï¼

<!--more-->

# é¢„å¤‡

## æµ‹è¯•ç›®æ ‡

æ¯è®°åç«¯æ˜¯æ²¡æœ‰å•å…ƒæµ‹è¯•çš„ï¼Œæ­¤æ¬¡å¯¹å…¶è¿›è¡Œæ·»åŠ å•å…ƒæµ‹è¯•çš„é‡æ„ã€‚

## æŠ€æœ¯é€‰å‹åŠé¡¹ç›®é…ç½®

ä¸»è¦æŠ€æœ¯å¦‚ä¸‹

- æµ‹è¯•å¹³å°ï¼šJUnit5
- mockåº“ï¼šMockK
- æ–­è¨€åº“ï¼šAssertK
- æµ‹è¯•è¦†ç›–ç‡ï¼šJacoco
- æ•°æ®å±‚æµ‹è¯•ï¼šembedded-database-spring-testã€flyway-spring-testã€mybatis-plus-spring-boot-test

gradleé…ç½®å¦‚ä¸‹

```groovy
plugins {
  id 'jacoco'
}

dependencies {
  // æµ‹è¯•ï¼šmockkæ›¿ä»£mockito,assertkæ›¿ä»£assertj;embedded-database
  testImplementation('org.springframework.boot:spring-boot-starter-test') {
    exclude module: 'mockito-core'
    exclude module: 'assertj-core'
  }
  testImplementation("com.ninja-squad:springmockk:3.1.0")
  testImplementation('com.willowtreeapps.assertk:assertk-jvm:0.25')
  testImplementation('io.zonky.test:embedded-database-spring-test:2.1.1')
  testImplementation('com.baomidou:mybatis-plus-boot-starter-test:3.5.1')
  testImplementation('org.flywaydb.flyway-test-extensions:flyway-spring-test:7.0.0')
}

// https://docs.gradle.org/current/dsl/org.gradle.api.tasks.testing.Test.html
// æµ‹è¯•æŠ¥å‘Šä½ç½®: build/reports/test
test {
  // ä½¿ç”¨JUnit5è¿›è¡Œæµ‹è¯•
  useJUnitPlatform()
  // æµ‹è¯•çº¿ç¨‹æ•°ï¼š2
  maxParallelForks(2)
  // æ—¥å¿—é…ç½®
  testLogging {
    // level=LIFECYCLEçš„é…ç½®é¡¹
    events "passed", "skipped", "failed"
    exceptionFormat "full"
  }
}

// ç”Ÿæˆè¦†ç›–ç‡æµ‹è¯•æŠ¥å‘Š: ./gradlew test jacocoTestReport
// æµ‹è¯•æŠ¥å‘Šä½ç½®: build/jacocoReport
jacocoTestReport {
  reports {
    xml.enabled = false
    csv.enabled = false
    html.enabled = true
    html.destination = file("${buildDir}/jacocoReport")
  }
}
```

æ—¥å¿—ï¼šsrc/test/resourcesä¸‹æ·»åŠ logback-test.xmlæ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…åœ¨æ§åˆ¶å°æ‰“å°WARNçº§åˆ«çš„åº”ç”¨æ—¥å¿—

```xml
<?xml version="1.0" encoding="UTF-8"?>

<configuration>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger - %msg %X{THREAD_ID} %n</pattern>
        </encoder>
    </appender>

    <root level="WARN">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

IDEAï¼šå®‰è£…JUnitæ’ä»¶ï¼ˆå¦‚æœæ˜¯IDEAä¸“ä¸šç‰ˆï¼Œé»˜è®¤å·²å®‰è£…ï¼‰ã€‚

## æµ‹è¯•æ€è·¯ - MVCå¦‚ä½•æµ‹è¯•

è¢«æµ‹é¡¹ç›®æ˜¯é‡‡ç”¨Spring Web MVCæ„å»ºçš„RestfulæœåŠ¡ï¼Œé‚£ä¹ˆMVCåº”è¯¥å¦‚ä½•æµ‹è¯•å‘¢ï¼Ÿ

å¦‚æœæˆ‘ä»¬å°†æ¯ä¸€å±‚çš„èŒè´£åŒºåˆ†å¾—æ¯”è¾ƒå¥½ï¼Œåˆ™æ¯å±‚è´Ÿè´£çš„å†…å®¹å’Œæµ‹è¯•æ€è·¯å¦‚ä¸‹

- Controllerï¼šè·¯ç”±è½¬å‘ã€å‚æ•°éªŒè¯
  - é‡ç‚¹åœ¨å‚æ•°éªŒè¯çš„æµ‹è¯•ï¼Œå¯¹Serviceçš„è°ƒç”¨åº”è¯¥è¢«Mockæ‰
  - ä½¿ç”¨MockMvc
  - ä½¿ç”¨@WebMvcTeståŠ è½½å•ä¸ªControllerç±»ï¼Œæå‡å¯åŠ¨é€Ÿåº¦
- Serviceï¼šä¸šåŠ¡é€»è¾‘çš„å¤„ç†
  - å¸¸è§„æµ‹è¯•ï¼Œå•å…ƒæµ‹è¯•çš„ä¸»è¦å·¥ä½œé›†ä¸­åœ¨è¿™é‡Œ
  - ä¸ä½¿ç”¨Spring Testçš„ä»»ä½•æ³¨è§£ï¼Œå¯ä»¥æå‡å¯åŠ¨é€Ÿåº¦
- Repositoryï¼šæ•°æ®åº“è®¿é—®
  - ä½¿ç”¨åµŒå…¥å¼æ•°æ®åº“æä¾›çœŸå®ç­‰ä»·çš„æ•°æ®åº“ç¯å¢ƒ
  - ä½¿ç”¨@MybatisPlusTeståªåŠ è½½æ•°æ®åº“ç›¸å…³çš„Beanï¼Œæå‡å¯åŠ¨é€Ÿåº¦

> ä½ å†™çš„æ˜¯å•å…ƒæµ‹è¯•è¿˜æ˜¯é›†æˆæµ‹è¯•ï¼Ÿ
>
> ä½¿ç”¨Spring Boot Testï¼Œæˆ‘ä»¬å†™å‡ºæ¥çš„å¾€å¾€æ˜¯é›†æˆæµ‹è¯•ã€‚å³ä¸€ä¸ªæµ‹è¯•ä¸­å…¶å®åŒ…å«äº†Controllerã€Serviceã€Repositoryã€‚ä½†çœŸçš„å•å…ƒæµ‹è¯•ï¼Œä¸€ä¸ªæµ‹è¯•åº”è¯¥åªåŒ…å«ä¸€ä¸ªæ–¹æ³•çš„ä¸€ç§caseã€‚
>
> é›†æˆæµ‹è¯•çš„å¥½å¤„æ˜¯å†™èµ·æ¥æ–¹ä¾¿å¿«æ·ï¼Œç¼ºç‚¹æ˜¯è¦†ç›–ä¸å…¨é¢ï¼Œä¸”ä¸€æ—¦ä¸€ä¸ªè°ƒç”¨é“¾è·¯çš„ä»»ä½•ç¯èŠ‚ä¿®æ”¹ï¼Œç›¸å…³çš„caseéƒ½å¿…é¡»ä¿®æ”¹ã€‚

æ¥ä¸‹æ¥çœ‹å…·ä½“çš„å®æ–½æƒ…å†µã€‚

# Controlleræµ‹è¯•

## æµ‹ä»€ä¹ˆ

- æµ‹è¯•æ¥å£è·¯ç”±æ˜¯å¦æ­£ç¡®
- æµ‹è¯•å‚æ•°éªŒè¯æ˜¯å¦ç¬¦åˆé¢„æœŸ

## ä¸€ä¸ªéœ€æ±‚

ä¸€ä¸ªå…¸å‹å¾…æµ‹è¯•çš„æ¥å£å¦‚ä¸‹

```kotlin
@RestController
class UserController(
    private val userService: UserService,
    private val subscriptionService: SubscriptionService
) {

  @Authenticate
  @PatchMapping("/users/{id}")
  fun updateUserInfo(
    @PathVariable id: Int,
    @RequestBody request: UserUpdateReq,
  ): R<User> {
    val initiator = RequestContext.getUserId()!!
    return R.succeed(userService.updateUserInfo(id, initiator, request))
  }
  
}
```

- @Authenticateè¡¨ç¤ºè¯¥æ¥å£éœ€è¦é‰´æƒï¼Œå…·ä½“é‰´æƒé€»è¾‘å¦‚ä¸‹

  ```kotlin
  @Component
  class AuthInterceptor(
    @Autowired val objectMapper: ObjectMapper
  ) : HandlerInterceptor {
  
    override fun preHandle(request: HttpServletRequest, response: HttpServletResponse, handler: Any): Boolean {
      // ä»å¤´éƒ¨å–X-5E-USERå­—æ®µå€¼ï¼Œè§£ææˆUserå¯¹è±¡
      val user = request.getHeader("X-5E-USER")?.let { objectMapper.readValue(it, User::class.java) }
  
      // åˆ¤æ–­æ–¹æ³•æ˜¯å¦è¢«@Authenticateæ³¨è§£ï¼Œå¦‚æœè¢«æ³¨è§£äº†ä¸”userä¸ºç©ºï¼Œåˆ™æŠ¥401é”™è¯¯
      val authorize = (handler as HandlerMethod).beanType.getDeclaredAnnotation(Authenticate::class.java)
      ?: handler.getMethodAnnotation(Authenticate::class.java)
      if (authorize != null && user == null) {
        throw ResponseException(ResErrCode.NEED_AUTHORIZE)
      }
      return true
    }
  
  }
  ```

- UserUpdateReqéœ€è¦è¢«éªŒè¯

  ```kotlin
  @ApiModel("æ›´æ–°ç”¨æˆ·ä¿¡æ¯")
  class UserUpdateReq {
  
    @ApiModelProperty("ç”¨æˆ·å")
    @NotBlank
    var name: String? = null
  
    @ApiModelProperty("å¤´åƒ")
    @NotBlank
    var avatar: String? = null
  
    @ApiModelProperty("ç”¨æˆ·æè¿°")
    @NotBlank
    var description: String? = null
  }
  ```

## æµ‹è¯•ç±»çš„æ„å»º

æµ‹è¯•ç±»çš„æ„å»ºï¼Œä¸»è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªå› ç´ 

- åªåŠ è½½Webé…ç½®å’Œå¾…æµ‹Controllerï¼Œå…¶å®ƒBeanéƒ½ä¸è¦ï¼Œæˆ‘ä»¬åŸºäº@WebMvcTestæ„å»ºè‡ªå·±çš„æ³¨è§£

  ```java
  @Inherited
  @Documented
  @Target(ElementType.TYPE)
  @Retention(RetentionPolicy.RUNTIME)
  @WebMvcTest
  // WebMvcConfigæ˜¯æœ¬ä¸šåŠ¡ä¸­è‡ªå®šä¹‰çš„Webé…ç½®
  @Import(WebMvcConfig.class)
  public @interface ControllerTest {
  
      @AliasFor(annotation = WebMvcTest.class)
      String[] properties() default {};
  
      @AliasFor(annotation = WebMvcTest.class)
      Class<?>[] value() default {};
  
      @AliasFor(annotation = WebMvcTest.class)
      Class<?>[] controllers() default {};
  
      @AliasFor(annotation = WebMvcTest.class)
      boolean useDefaultFilters() default true;
  
      @AliasFor(annotation = WebMvcTest.class)
      Filter[] includeFilters() default {};
  
      @AliasFor(annotation = WebMvcTest.class)
      Filter[] excludeFilters() default {};
  
      @AliasFor(annotation = WebMvcTest.class)
      Class<?>[] excludeAutoConfiguration() default {};
  
  }
  ```

- ä¸€ä¸ªControllerä¸€ä¸ªæµ‹è¯•ç±»ï¼Œä½†æ¯ä¸ªæ¥å£éƒ½æœ‰å¥½å‡ ä¸ªcaseï¼Œå› æ­¤éœ€è¦åˆ†ç»„ã€‚ç”¨å†…éƒ¨ç±»+@Nestedå®ç°ï¼Œä¸è¿‡è¿™æ ·çš„è¯ï¼Œä¸€ä¸ªå†…éƒ¨ç±»å¯¹åº”ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç®¡ç†å…¬å…±å±æ€§

  ```kotlin
  interface IRequestMapping {
  
    /**
     * æŒ‡å®šæœ¬æ¬¡æµ‹è¯•çš„è·¯å¾„
     */
    val path: String
  
    /**
     * é’ˆå¯¹è¯¥è·¯å¾„çš„mockã€‚è¿™æ ·ï¼Œå­ç±»åªéœ€è¦è°ƒç”¨mockRequestå³å¯è¯·æ±‚ï¼Œè€Œä¸éœ€è¦æ¯ä¸ªcaseé‡æ–°æ„å»ºå¡«å†™pathã€methodç­‰é‡å¤å‚æ•°
     */
    fun mockRequest(block: MockHttpServletRequestDsl.() -> Unit = {}): ResultActionsDsl
  
    fun mockRequestWithToken(block: MockHttpServletRequestDsl.() -> Unit = {}): ResultActionsDsl {
      return mockRequest {
        header(mockAuthHeader.first, mockAuthHeader.second)
        block(this)
      }
    }
  
    fun mockRequestWithEmptyContent(block: MockHttpServletRequestDsl.() -> Unit = {}): ResultActionsDsl {
      return mockRequest {
        content = "{}"
        block(this)
      }
    }
  
  }
  ```

- å®é™…ä¸Šï¼Œæ‰€æœ‰çš„æ¥å£éƒ½æœ‰ä¸¤ä¸ªå…±åŒçš„éœ€æ±‚ï¼Œæˆ‘ä»¬å°†å…¶å†™æˆçˆ¶ç±»

  - éƒ½éœ€è¦æµ‹è¯•é‰´æƒ

    ```kotlin
    interface AuthenticateTest : IRequestMapping {
      @Test
      fun `401 when missing token`() {
        mockRequestWithEmptyContent().andExpect {
          status {
            isUnauthorized()
          }
        }
      }
    }
    ```

  - éƒ½éœ€è¦éªŒè¯å“åº”ç»“æ„

    ```kotlin
    interface ResponseFormatTest : IRequestMapping {
      @Test
      fun `response format validate`() {
        val mockResult = mockRequestWithEmptyContent().andReturn()
        assertThat(mockResult.response.contentType).isEqualTo(MediaType.APPLICATION_JSON.toString())
        val resNode = publicObjectMapper.readTree(mockResult.response.contentAsString)
        assertThat(publicObjectMapper.convertValue(resNode, R::class.java)).isInstanceOf(R::class)
      }
    }
    ```

è¿™æ ·ï¼Œå°±æ„å»ºå¾—åˆ°å¦‚ä¸‹æµ‹è¯•ç±»

```kotlin

@DisplayName("ç”¨æˆ·å‚æ•°éªŒè¯")
@ControllerTest(UserController::class)
class UserControllerTest {

  @Autowired
  private lateinit var mockMvc: MockMvc

  @MockkBean
  private lateinit var subscriptionService: SubscriptionService

  @MockkBean(relaxed = true)
  private lateinit var userService: UserService

  // åŒæ—¶éœ€è¦éªŒè¯é‰´æƒå’Œå“åº”æ ¼å¼
  @Nested
  @DisplayName("æ›´æ–°ç”¨æˆ·ä¿¡æ¯")
  inner class UpdateUserInfo : AuthenticateTest, ResponseFormatTest {

    // æŒ‡å®šæ¥å£è·¯å¾„
    override val path: String = "/users/1"

    // æŒ‡å®šæ¥å£çš„methodå’ŒcontentTypeç­‰å…¬å…±å±æ€§
    override fun mockRequest(block: MockHttpServletRequestDsl.() -> Unit): ResultActionsDsl {
      return mockMvc.patch(path) {
        contentType = MediaType.APPLICATION_JSON
        block(this)
      }
    }

    // å¼‚å¸¸caseçš„æµ‹è¯•
    @ParameterizedTest(name = "{displayName} {argumentsWithNames}")
    @CsvSource(
      value = [
        "'', '', null",
        "' ', null, éç©º"
      ],
      nullValues = ["null"]
    )
    fun `400 when illegal input`(name: String?, avatar: String?, description: String?) {
      mockRequestWithToken {
        val mockBody = UserUpdateReq().apply {
          this.name = name
          this.avatar = avatar
          this.description = description
        }
        content = mockBody.toJsonString()
      }.andExpect {
        status { isBadRequest() }
      }
    }

    // æ­£å¸¸caseçš„æµ‹è¯•
    @ParameterizedTest(name = "{displayName} {argumentsWithNames}")
    @CsvSource(
      value = [
        "null, null, null",
        "null, null, éç©º"
      ],
      nullValues = ["null"]
    )
    fun `200 when legal input`(name: String?, avatar: String?, description: String?) {
      mockRequestWithToken {
        val mockBody = UserUpdateReq().apply {
          this.name = name
          this.avatar = avatar
          this.description = description
        }
        content = mockBody.toJsonString()
      }.andExpect {
        status { isOk() }
      }
    }

  }
}
```

## å…³äºJsonæ ¼å¼çš„æµ‹è¯•

å½“å‰é¡¹ç›®ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„éœ€æ±‚ï¼šèµ„æºä¿å­˜æ¥å£ï¼Œèµ„æºçš„ç»“æ„å¦‚ä¸‹ï¼Œæ¯æ¬¡ä¿å­˜æ—¶éœ€è¦éªŒè¯èµ„æºçš„ç»“æ„æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

```json
{
  "resourceId": "1233",
  "resourceType": "record",
  "data": {
    "...": "...",
    "...": "...",
    "...": "...",
  }
}
```

å…¶ä¸­çš„dataç»“æ„ä¸å›ºå®šï¼Œå¤šè¾¾äº”å…­ç§ã€‚æœåŠ¡ç«¯å°†dataçš„éªŒè¯é€»è¾‘å†™æˆäº†json schemaï¼Œä»¥è‡ªå®šä¹‰validatorçš„å½¢å¼åŠ å…¥Springä¸­ã€‚ç°åœ¨è¦å¯¹è¿™äº›éªŒè¯é€»è¾‘è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚

è¿™å…¶ä¸­çš„æµ‹è¯•éš¾ç‚¹åŠè§£å†³æ–¹æ³•å¦‚ä¸‹

- æµ‹è¯•æ•°æ®é‡å¤§

  å°†æµ‹è¯•æ•°æ®å†™åœ¨æ–‡ä»¶ä¸­ï¼Œé€šè¿‡æ–‡ä»¶è¯»å–å„æ¡æµ‹è¯•æ•°æ®ï¼Œå†ä»¥å‚æ•°åŒ–å½¢å¼ä¼ å…¥æµ‹è¯•caseã€‚éœ€è¦ç”¨åˆ°JUnitçš„@ParameterizedTest + @MethodSourceè¾¾æˆ

- æµ‹è¯•caseå¤š

  æˆ‘ä»¬æå–äº†æœ€å¸¸è§çš„caseï¼Œå¯¹å®ƒä»¬è¿›è¡Œæ•°æ®æ„å»º

  - é¢„æœŸæˆåŠŸçš„case

    - æ‹¥æœ‰æœ€å°‘åˆæ³•å…ƒç´ 
    - æ‹¥æœ‰æœ€å¤šåˆæ³•å…ƒç´ 
    - å¯ç©ºå…ƒç´ éƒ½ä¸ºnull

    ä»¥tagä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°é™¤äº†æ•°æ®ä¹‹å¤–æˆ‘ä»¬è¿˜æ·»åŠ äº†é’ˆå¯¹è¯¥æ•°æ®çš„è¯´æ˜ï¼š\_comment_å­—æ®µï¼Œè¿™åœ¨æµ‹è¯•ç»“æœä¸­ä¼šæ‰“å°å‡ºæ¥

    ```json
    [
      {
        "_comment_": "æ‹¥æœ‰æœ€å°‘åˆæ³•å…ƒç´ ",
        "resourceId": "12345678901234567890123456789012",
        "resourceType": "tag",
        "usn": 1,
        "data": {
          "id": "12345678901234567890123456789012",
          "title": "5qCH562+5qCH6aKY",
          "created_time": 1,
          "updated_time": 1,
          "version": 3
        }
      },
      {
        "_comment_": "æ‹¥æœ‰æœ€å¤šåˆæ³•å…ƒç´ ",
        "resourceId": "12345678901234567890123456789012",
        "resourceType": "tag",
        "usn": 1,
        "data": {
          "id": "12345678901234567890123456789012",
          "title": "5qCH562+5qCH6aKY",
          "description": "5o+P6L+w",
          "created_time": 1,
          "updated_time": 1,
          "deleted_time": 1,
          "version": 3,
          "usn": 1
        }
      },
      {
        "_comment_": "å¯ç©ºå…ƒç´ éƒ½ä¸ºnull",
        "resourceId": "12345678901234567890123456789012",
        "resourceType": "tag",
        "usn": null,
        "data": {
          "id": "12345678901234567890123456789012",
          "title": "5qCH562+5qCH6aKY",
          "description": null,
          "created_time": 1,
          "updated_time": 1,
          "deleted_time": null,
          "version": 3,
          "usn": null
        }
      }
    ]
    ```

  - é¢„æœŸå¤±è´¥çš„case

    - å¿…é¡»å­—æ®µæœªå‡ºç°
    - ä¸å¯ç©ºå…ƒç´ è®¾ç½®ä¸ºnull
    - æ•°æ®ç±»å‹é—®é¢˜ï¼šæ•…æ„å°†æ¯ä¸ªå…ƒç´ çš„æ•°æ®ç±»å‹å†™é”™
    - æ•°æ®æ ¼å¼é—®é¢˜ï¼šæ•…æ„å°†æ¯ä¸ªå…ƒç´ çš„æ•°æ®æ ¼å¼å†™é”™
    - å‡ºç°æœªå®šä¹‰çš„å­—æ®µ

    åŒæ ·ä»¥tagä¸ºä¾‹ï¼Œä¸åŒçš„æ˜¯è¿™æ¬¡è¿˜å¤šäº†\_errorKeywords_å­—æ®µï¼ŒæŒ‡å‡ºäº†è¯¥caseçš„é”™è¯¯ä¿¡æ¯å¿…é¡»åŒ…å«çš„å…³é”®å­—

    ```json
    [
      {
        "_comment_": "å¿…é¡»å­—æ®µæœªå‡ºç°",
        "_errorKeywords_": [
          "id",
          "title",
          "created_time",
          "updated_time",
          "version"
        ],
        "resourceId": "12345678901234567890123456789012",
        "resourceType": "tag",
        "usn": 1,
        "data": {}
      },
      {
        "_comment_": "å­—æ®µå¯ç©ºé—®é¢˜: id, title, created_time, updated_time, version",
        "_errorKeywords_": [
          "id",
          "title",
          "created_time",
          "updated_time",
          "version"
        ],
        "resourceId": "12345678901234567890123456789012",
        "resourceType": "tag",
        "usn": 1,
        "data": {
          "id": null,
          "title": null,
          "description": "5o+P6L+w",
          "created_time": null,
          "updated_time": null,
          "deleted_time": 1,
          "version": null,
          "usn": 1
        }
      },
      {
        "_comment_": "æ•°æ®ç±»å‹é—®é¢˜: idã€titleã€descriptionä¸ºstring;å…¶å®ƒä¸ºæ•°å­—",
        "_errorKeywords_": [
          "id",
          "title",
          "description",
          "created_time",
          "updated_time",
          "deleted_time",
          "version",
          "usn"
        ],
        "resourceId": "12345678901234567890123456789012",
        "resourceType": "tag",
        "usn": 1,
        "data": {
          "id": 1,
          "title": 1,
          "description": 1,
          "created_time": "1",
          "updated_time": "1",
          "deleted_time": "1",
          "version": "3",
          "usn": "1"
        }
      },
      {
        "_comment_": "æ•°æ®æ ¼å¼é—®é¢˜: idä¸º32ä½;titleã€descriptionä¸ºbase64;versionå›ºå®šä¸º3",
        "_errorKeywords_": [
          "id",
          "title",
          "description",
          "version"
        ],
        "resourceId": "12345678901234567890123456789012",
        "resourceType": "tag",
        "usn": 1,
        "data": {
          "id": "123456789012345678901234567890",
          "title": "æ˜æ–‡æ ‡é¢˜",
          "description": "æ˜æ–‡æè¿°",
          "created_time": 1,
          "updated_time": 1,
          "deleted_time": 1,
          "version": 2,
          "usn": 1
        }
      },
      {
        "_comment_": "å‡ºç°æœªå®šä¹‰å­—æ®µ: undefinedField",
        "_errorKeywords_": [
          "undefinedField"
        ],
        "resourceId": "12345678901234567890123456789012",
        "resourceType": "tag",
        "usn": 1,
        "data": {
          "id": "12345678901234567890123456789012",
          "title": "5qCH562+5qCH6aKY",
          "description": "5o+P6L+w",
          "created_time": 1,
          "updated_time": 1,
          "deleted_time": 1,
          "version": 3,
          "usn": 1,
          "undefinedField": ""
        }
      }
    ]
    ```

  ç›®å‰ä¸ºæ­¢æ‰€æœ‰æ•°æ®æœ‰è¿™ä¹ˆå¤šï¼š

  ![image-20220305174323051](https://gdz.oss-cn-shenzhen.aliyuncs.com/local/image-20220305174323051.png)

è‡³äºæµ‹è¯•æ–¹æ³•ï¼Œæˆ‘ä»¬è¿™æ ·å†™

```kotlin
@ParameterizedTest(name = "{displayName} {argumentsWithNames}")
@MethodSource("com.project5e.app.mylog.controller.mock.ResourceProvider#provideLegalResource")
fun `200 when legal resource`(type: String, comment: String, content: String) {
  every { resourceService.saveV2(any()) } returns listOf()
  mockRequestWithToken {
    this.content = content
  }.andExpect {
    status { isOk() }
  }
}

@ParameterizedTest(name = "{displayName} {argumentsWithNames}")
@MethodSource("com.project5e.app.mylog.controller.mock.ResourceProvider#provideIllegalResource")
fun `400 when illegal resource`(type: String, comment: String, errorKeyWords: List<String>, content: String) {
  val mvcResult = mockRequestWithToken {
    this.content = content
  }.andExpect {
    status { isBadRequest() }
  }.andReturn()

  errorKeyWords.forEach { errorKeyWord ->
                         assertThat(mvcResult.response.contentAsString).contains(errorKeyWord)
                        }
}
```

æµ‹è¯•æ•°æ®è¯»å–æ–¹æ³•å¦‚ä¸‹

```kotlin
object ResourceProvider {

    private const val RESOURCE_FILE_SUFFIX = "json"
    private const val LEGAL_RESOURCE_PATTERN = "classpath:mock-resource/legal/*.$RESOURCE_FILE_SUFFIX"
    private const val ILLEGAL_RESOURCE_PATTERN = "classpath:mock-resource/illegal/*.$RESOURCE_FILE_SUFFIX"

    private const val COMMENT_KEY = "_comment_"
    private const val ERROR_KEYWORDS_KEY = "_errorKeywords_"

    @JvmStatic
    fun provideLegalResource(): List<Arguments> {
        return PathMatchingResourcePatternResolver().getResources(LEGAL_RESOURCE_PATTERN).map { resource ->
            resource.file.name to publicObjectMapper.readTree(resource.file)
        }.map { (fileName, mockResources) ->
            mockResources.map { mockResource ->
                val resourceType = fileName.removeSuffix(RESOURCE_FILE_SUFFIX)
                val comment = (mockResource as ObjectNode).remove(COMMENT_KEY).asText()
                val content = """{"resources": [${mockResource.toJsonString()}]}"""
                Arguments.of(resourceType, comment, content)
            }
        }.flatten()
    }

    @JvmStatic
    fun provideIllegalResource(): List<Arguments> {
        return PathMatchingResourcePatternResolver().getResources(ILLEGAL_RESOURCE_PATTERN).map { resource ->
            resource.file.name to publicObjectMapper.readTree(resource.file)
        }.map { (fileName, mockResources) ->
            mockResources.map { it as ObjectNode }.map { mockResource ->
                val resourceType = fileName.removeSuffix(RESOURCE_FILE_SUFFIX)
                val comment = mockResource.remove(COMMENT_KEY).asText()
                val errorKeywords = mockResource.remove(ERROR_KEYWORDS_KEY).map { it.asText() }
                val content = """{"resources": [${mockResource.toJsonString()}]}"""
                Arguments.of(resourceType, comment, errorKeywords, content)
            }
        }.flatten()
    }
}
```

å¦‚æœè¿è¡Œæµ‹è¯•ï¼Œèƒ½å¤Ÿå¾—åˆ°å¦‚ä¸‹è¾“å‡º

![image-20220305174813410](https://gdz.oss-cn-shenzhen.aliyuncs.com/local/image-20220305174813410.png)

## å¯ä»¥æ”¹è¿›çš„åœ°æ–¹

- controllerå±‚æµ‹è¯•è¿˜å¯ä»¥å†æŠ½è±¡ï¼šä¸éœ€è¦å†™ä»£ç ï¼Œé€šè¿‡excelæˆ–dbå½•å…¥è®¿é—®è·¯å¾„ã€é¢„æœŸè¾“å…¥ã€é¢„æœŸè¾“å‡ºï¼Œç›´æ¥ç”Ÿæˆæµ‹è¯•ä»£ç ç”Ÿæˆï¼Œæ›´ä¸ºæ–¹ä¾¿
- controllerå±‚æµ‹è¯•æˆ–è®¸å¯ä»¥å’Œé›†æˆæµ‹è¯•åˆå¹¶ã€‚ä½†ä¹Ÿä¸å°½ç„¶ï¼Œé›†æˆæµ‹è¯•ä¸ä¸€å®šè¦åœ¨controllerè¿™ä¸€æ¬¡å±‚åšï¼Œä»¥serviceä¸ºå…¥å£æˆ–è®¸æ›´åŠ æ–¹ä¾¿

# Serviceæµ‹è¯•

## æµ‹ä»€ä¹ˆ

- æµ‹è¯•ä¸šåŠ¡é€»è¾‘

## ä¸€ä¸ªéœ€æ±‚

```kotlin
@Service
class UserService(@Autowired private val userDao: UserDao) {

  @Value("\${user.appid}")
  lateinit var appId: String

  @Value("\${user.fresh.avatar}")
  lateinit var freshUserAvatar: String

  @GrpcClient("user-service")
  lateinit var userStub: UserServiceGrpc.UserServiceBlockingStub

  fun updateUserInfo(id: Int, initiator: Int, request: UserUpdateReq): User {
    if (id != initiator) {
      throw ResponseException(ResErrCode.ILLEGAL_REQUEST, "ä¸å¯ä¿®æ”¹ä»–äººä¿¡æ¯")
    }
    if (!request.isAllFieldNull()) {
      userDao.updateUserInfo(id, request)
    }
    return getUserInfo(id)
  }
}
```

## æ„å»ºæµ‹è¯•ç±»

åœ¨Controlleræµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†@Nested+å†…éƒ¨ç±»çš„æ–¹å¼å¯¹æ¥å£è¿›è¡Œäº†åˆ†ç»„ã€‚ä½†æ˜¯åœ¨Serviceä¸­ï¼Œå¾€å¾€æœ‰å¾ˆå¤šä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•çš„caseä¹Ÿä¼šéå¸¸å¤šï¼Œå¦‚æœè¿˜é‡‡ç”¨å’ŒControllerä¸€æ ·çš„æ–¹å¼ï¼Œæµ‹è¯•ç±»ä¼šçˆ†ç‚¸ã€‚å› æ­¤æˆ‘ä»¬é‡‡ç”¨ç±»ç»§æ‰¿çš„æ–¹å¼è¿›è¡Œåˆ†ç»„ã€‚

çˆ¶ç±»å¦‚ä¸‹ï¼šå®šä¹‰äº†mockå¯¹è±¡å’Œæµ‹è¯•å¯¹è±¡ï¼Œä»¥åŠæµ‹è¯•å¯¹è±¡ä¸­çš„å…±äº«mockå±æ€§

```kotlin
@ExtendWith(MockKExtension::class)
open class UserServiceTest {

    @RelaxedMockK
    protected lateinit var userDao: UserDao

    @InjectMockKs
    protected lateinit var userService: UserService

    @BeforeEach
    @Order(Int.MIN_VALUE)
    fun setUp() {
        userService.appId = MOCK_APP_ID
        userService.freshUserAvatar = MOCK_FRESH_USER_AVATAR
        userService.userStub = mockk(relaxed = true)
    }

}
```

é’ˆå¯¹éœ€æ±‚ä¸­çš„æ–¹æ³•çš„æµ‹è¯•ç±»å¦‚ä¸‹ï¼Œåªéœ€è¦å†™æµ‹è¯•æ–¹æ³•å³å¯

```kotlin
@DisplayName("UserServiceæµ‹è¯• > æ›´æ–°ç”¨æˆ·ä¿¡æ¯")
class UpdateUserInfoTest : UserServiceTest() {

    @Test
    fun `reject when update others info`() {
        val mockUserId = MOCK_USER_ID
        val mockInitiatorId = MOCK_USER_ID + 1
        val mockRequest = UserUpdateReq()

        assertThat { userService.updateUserInfo(mockUserId, mockInitiatorId, mockRequest) }.isFailure()
            .isInstanceOf(ResponseException::class)
            .matchesPredicate { it.errorCode == ResErrCode.ILLEGAL_REQUEST }
    }

    @Test
    fun `success when empty request`() {
        val spyUserService = spyk(userService)
        every { spyUserService.getUserInfo(any()) } returns User()

        spyUserService.updateUserInfo(MOCK_USER_ID, MOCK_USER_ID, UserUpdateReq())

        verify { userDao wasNot called }
    }

    @Test
    fun `success when non-empty request`() {
        val mockUserId = MOCK_USER_ID
        val mockInitiatorId = MOCK_USER_ID
        val mockRequest = UserUpdateReq().apply {
            this.name = "å‡åï¼Œåªè®©å®ƒéç©º"
        }
        val spyUserService = spyk(userService)
        val mockUpdateResult = User()

        every { spyUserService.getUserInfo(any()) } returns mockUpdateResult

        val updateResult = spyUserService.updateUserInfo(mockUserId, mockInitiatorId, mockRequest)

        val idSlot = slot<Int>()
        val requestSlot = slot<UserUpdateReq>()
        verify { userDao.updateUserInfo(capture(idSlot), capture(requestSlot)) }
        assertThat(idSlot.captured).isEqualTo(mockUserId)
        assertThat(requestSlot.captured).isEqualTo(mockRequest)
        assertThat(updateResult).isEqualTo(mockUpdateResult)
    }

}
```

> å¦‚ä½•è„±ç¦»Spring 
>
> å½“Serviceä¾èµ–Beançš„æ³¨å…¥ä½¿ç”¨æ„é€ å™¨æ³¨å…¥æ—¶ï¼Œå¯¹Serviceå±‚çš„å•å…ƒæµ‹è¯•å°±èƒ½è„±ç¦»Springï¼šå› ä¸ºMockKåœ¨æ„å»ºæµ‹è¯•å¯¹è±¡æ—¶ï¼Œæ˜¯é€šè¿‡æ„é€ å™¨æ³¨å…¥çš„ã€‚å¦åˆ™å°±å¾—ä¸€ä¸ªä¸ªæ‰‹åŠ¨mock

## è®©ä»£ç æ›´æ˜“äºæµ‹è¯•

æœ€æ˜“äºæµ‹è¯•çš„ä»£ç å½“ç„¶æ˜¯çº¯å‡½æ•°å¼ï¼Œä¸€ä¸ªç¡®å®šçš„è¾“å…¥å°±èƒ½å¯¹åº”ä¸€ä¸ªç¡®å®šçš„è¾“å‡ºã€‚ä½†ç†æƒ³ä¸ç°å®æ˜¯æœ‰å·®åˆ«çš„ï¼Œæ—¥å¸¸ä¸šåŠ¡ä¸­è¿‡åˆ†è¿½æ±‚å‡½æ•°å¼å¯èƒ½ä¼šä½¿å¾—ä»£ç æ™¦æ¶©éš¾æ‡‚ã€‚å°½é‡å‡½æ•°å¼+mockæ‰æ˜¯æ­£è§£ã€‚ä½†æ˜¯å‰¯ä½œç”¨å’Œå‡½æ•°å†…éƒ¨çš„çº§è”è°ƒç”¨è¿‡å¤šï¼Œåˆä¼šé€ æˆmockç¾éš¾ã€‚æ‰€ä»¥è¿˜æ˜¯ä¸€ä¸ªæƒè¡¡çš„è¿‡ç¨‹ã€‚

æŒ‰ç…§ä¸ªäººç»éªŒæ€»ç»“ä¸€ä¸‹å°±æ˜¯

- å‡½æ•°å¼+é€‚å½“mock
- åŠŸèƒ½æ‹†è§£ï¼šå¤æ‚æ–¹æ³•æ‹†åˆ†æˆè‹¥å¹²å°çš„æ–¹æ³•ï¼Œåˆ†åˆ«æµ‹è¯•ï¼Œè¿™æ ·å¼¹æ€§æ›´é«˜

ä¸€ä¸ªä¾‹å­ï¼šå¦‚ä¸‹æ˜¯é‡æ„ä¹‹å‰çš„ä¸€ä¸ªæ–¹æ³•ï¼ˆè·å–ç”¨æˆ·é‚€è¯·ä¿¡æ¯ï¼‰ï¼Œå¦‚æ­¤ä¹‹å¤§ï¼Œå¾ˆæ˜¾ç„¶æ˜¯æ— æ³•æµ‹è¯•çš„

```kotlin
		fun getInvitationInfo(): InvitationInfoResponseDto {
        val currentUser = RequestContext.currentUser
        // ä»åº“ä¸­è·å–é‚€è¯·ç ï¼Œæ²¡æœ‰å°±ç”Ÿæˆä¸€ä¸ªæ’å…¥åº“ä¸­
        var userModel = userDao.getById(currentUser)
        if (userModel.invitationCode.isNullOrEmpty()) {
            userModel.invitationCode = userDao.generateInvitationCode().toUpperCase()
            userModel.invitedCount = 0
            // å°è¯•æ›´æ–°ï¼Œå¦‚æœæç¤ºå†²çªï¼Œè¯´æ˜å‘ç”Ÿäº†å¹¶å‘é—®é¢˜ï¼Œä»¥åº“ä¸­å·²æœ‰ä¸ºå‡†ã€‚ä¸è¿‡è¿™èƒ½å‘ç”Ÿçš„å‰ææ˜¯æ•°æ®è¡¨é’ˆå¯¹invitation_codeåšäº†uniqueé™åˆ¶
            runCatching { userModel.updateById() }.exceptionOrNull()
                ?.takeIf { it.message?.contains("duplicate") == true }
                ?.run { userModel = userDao.getById(currentUser) }
        }

        // æŸ¥å‡ºä¸€ä¸²è®°å½•ï¼Œä½œä¸ºåé¢çš„è®¡ç®—ä¾æ®
        val invitedHistory = invitationHistoryDao.getByInvitee(currentUser)
        val redeemHistory = invitationRedeemHistoryDao.listByRedeemer(currentUser)
        val subscriptionModel = subscriptionService.ktQuery().eq(SubscriptionModel::userId, currentUser).one()

        // å¥–å“æ„å»ºï¼šåŸºæœ¬ä¿¡æ¯å›ºå®šï¼Œåªéœ€å¡«å……å…‘æ¢çŠ¶æ€ã€æ˜¯å¦å¯ç”¨ï¼ˆç½®ç°çŠ¶æ€ï¼‰
        val awards = awardModels.map { InvitationInfoResponseDto.Award().fillWith(it) }.onEach { award ->
            award.redeemed = redeemHistory.any { it.awardId == award.id }
            // å¸¸è§„caseï¼šé‚€è¯·æ•°å¤Ÿä¸”æœªè¢«å…‘æ¢ï¼Œåˆ™é«˜äº®ã€‚å¦åˆ™ç½®ç°
            award.enable = (userModel.invitedCount!! >= award.triggerCount!!) && !award.redeemed!!
        }
        val standardAward = awards.single { it.membershipLevel == MembershipLevel.STANDARD }
        val premiumAward = awards.single { it.membershipLevel == MembershipLevel.PREMIUM }
        // ç‰¹æ®Šcase1ï¼šåªè¦é«˜çº§æœ‰æ•ˆ(è¦ä¹ˆè´­ä¹°è¦ä¹ˆå…‘æ¢)ï¼Œæ™®é€šå¥–åŠ±å°±ç½®ç°
        if (subscriptionModel?.membershipLevel == MembershipLevel.PREMIUM) {
            standardAward.enable = false
        }

        // æ„å»ºå®Œæ•´çš„é‚€è¯·ä¿¡æ¯
        return InvitationInfoResponseDto().apply {
            this.invitationCode = userModel.invitationCode
            this.invitedCount = userModel.invitedCount
            this.hasBeenInvited = invitedHistory != null
            this.awards = awards
        }
    }
```

å¦‚ä¸‹æ˜¯é‡æ„ä¹‹åçš„ä»£ç ï¼ŒæŒ‰åŠŸèƒ½æ‹†åˆ†ï¼Œä¸ä½†æ›´æ˜“æµ‹ï¼Œå¯è¯»æ€§ä¹Ÿå¢å¼ºäº†ä¸å°‘ã€‚ä¹‹å‰çš„ä»£ç ä¸ä¸€ç‚¹ç‚¹çœ‹ä½ ä¸€å®šä¸çŸ¥é“å®ƒåœ¨å¹²å•¥

```kotlin
		fun getInvitationInfo(): InvitationInfoResponseDto {
        val currentUser = RequestContext.currentUser
        val (invitationCode, invitedCount) = getInvitationCodeAndInvitedCount(currentUser)
        val hasBeenInvited = hasBeenInvited(invitationHistoryDao.getByInvitee(currentUser))
        val awards = awardModels.map { InvitationInfoResponseDto.Award().fillWith(it) }
        fillAwardRedeemed(awards, invitationRedeemHistoryDao.listByRedeemer(currentUser))
        fillAwardEnable(awards, currentUser, invitedCount, subscriptionDao.getByUserId(currentUser))

        return InvitationInfoResponseDto().apply {
            this.invitationCode = invitationCode
            this.invitedCount = invitedCount
            this.hasBeenInvited = hasBeenInvited
            this.awards = awards
        }
    }

    fun getInvitationCodeAndInvitedCount(userId: Int): Pair<String, Int> {
        var userModel = userDao.getById(userId)!!
        if (userModel.invitationCode.isNullOrEmpty()) {
            userModel.invitationCode = generateCode()
            userModel.invitedCount = 0
            // å°è¯•æ›´æ–°ï¼Œå¦‚æœæç¤ºå†²çªï¼Œè¯´æ˜å‘ç”Ÿäº†å¹¶å‘é—®é¢˜ï¼Œä»¥åº“ä¸­å·²æœ‰ä¸ºå‡†ã€‚å‰æï¼šinvitation_codeåšäº†uniqueé™åˆ¶
            try {
                userDao.updateById(userModel)
            } catch (_: DuplicateKeyException) {
                userModel = userDao.getById(userId)!!
            }
        }
        return userModel.invitationCode!! to userModel.invitedCount!!
    }

    fun generateCode(): String {
        val tryCount = 3
        (0..tryCount).forEach { _ ->
            val candidate = UUID.randomUUID().toString().takeLast(6).toUpperCase()
            if (userDao.getByInvitationCode(candidate) == null) {
                return candidate
            }
        }
        log.error("é‚€è¯·ç ç”Ÿæˆå¤±è´¥ï¼Œè¯·æŸ¥æ‰¾é—®é¢˜")
        throw ResponseException(ResErrCode.COMM_ERROR)
    }

    fun hasBeenInvited(invitationHistoryModel: InvitationHistoryModel?): Boolean {
        return invitationHistoryModel != null
    }

    fun fillAwardRedeemed(
        awards: List<InvitationInfoResponseDto.Award>, redeemHistory: List<InvitationRedeemHistoryModel>
    ) = awards.forEach { award ->
        award.redeemed = redeemHistory.any { it.awardId == award.id }
    }

    fun fillAwardEnable(
        awards: List<InvitationInfoResponseDto.Award>, userId: Int, invitedCount: Int, subscription: SubscriptionModel?
    ) {
        awards.forEach { award ->
            award.enable = (invitedCount >= award.triggerCount!!) && !award.redeemed!!
        }
        val standardAward = awards.single { it.membershipLevel == MembershipLevel.STANDARD }
        // ç‰¹æ®Šcase1ï¼šåªè¦é«˜çº§æœ‰æ•ˆ(è¦ä¹ˆè´­ä¹°è¦ä¹ˆå…‘æ¢)ï¼Œæ™®é€šå¥–åŠ±å°±ç½®ç°
        if (subscription?.membershipLevel == MembershipLevel.PREMIUM) {
            standardAward.enable = false
        }
    }
```

> ä¸€ä¸ªç»éªŒï¼šåœ¨é‡æ„ä¸€ä¸ªå¤§æ–¹æ³•æ—¶ï¼Œé¢„æƒ³æ‹†åˆ†æˆå¤šä¸ªå­æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•å†™æˆå®Œå…¨æ— å‰¯ä½œç”¨ã€æ— çº§è”æ–¹æ³•è°ƒç”¨ï¼Œè¿™æ ·åšçš„ç»“æœæ˜¯å­æ–¹æ³•åŒ…å«å¾ˆå¤šé«˜é˜¶æ–¹æ³•ï¼Œå¯è¯»æ€§ç›¸è¾ƒäºå‰ï¼Œå·®äº†ä¸å°‘ã€‚

## ä¸è¦è¿‡åˆ†çº ç»“BDDé£æ ¼

BDDé£æ ¼å³æ‰€è°“çš„ given - when - then ç»“æ„ï¼ˆmockæ•°æ® - æ‰§è¡Œè¢«æµ‹æ–¹æ³• - æ–­è¨€åˆ¤æ–­ï¼‰ï¼ŒAssertJæä¾›BDDé£æ ¼çš„æ–­è¨€ã€‚ä½†givené˜¶æ®µç”±Mockåº“å†³å®šï¼Œthené˜¶æ®µç”±æ–­è¨€åº“å†³å®šã€‚è¿™ä¸¤ä¸ªåº“é€šå¸¸è¿˜ä¸æ˜¯ä¸€ä¸ªï¼Œæ‰€ä»¥APIå¾ˆå¯èƒ½ç»„åˆä¸å‡ºé¢„æƒ³çš„æ•ˆæœã€‚è¿˜ä¸å¦‚è€è€å®å®ç”¨every{}è¿›è¡Œmockï¼ŒassertThat()è¿›è¡Œæ–­è¨€ï¼Œçº¦å®šä¿—æˆï¼Œè¨€ç®€æ„èµ…ï¼Œå¤§å®¶éƒ½æ‡‚ã€‚

# Repositoryæµ‹è¯•

å¯¹è¯¥å±‚çš„æµ‹è¯•éš¾ç‚¹åŠè§£å†³æ–¹æ³•å¦‚ä¸‹

- æ•°æ®åº“ç¯å¢ƒéš¾ä»¥æ­å»º

  å¯¹äºMySQLï¼Œè¿˜æœ‰åµŒå…¥å¼æ•°æ®åº“H2å¯ä¾›é€‰æ‹©ã€‚ä½†å¯¹äºPostgreSQLï¼Œæœ‰ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼š[embedded-postres](https://github.com/zonkyio/embedded-postgres)ï¼Œæµ‹è¯•æœŸé—´å¯åŠ¨æ•°æ®åº“ï¼Œæ”¯æŒPG11ç‰ˆæœ¬ä»¥ä¸Šï¼Œæ”¯æŒrun in dockerã€‚è¿™æ˜¯çœŸå®çš„ç¯å¢ƒï¼Œåº”è¯¥è¯´æ˜¯ç»ä½³é€‰æ‹©äº†ã€‚

- MyBatis Pluså†™çš„å¦‚ä½•æµ‹è¯•

  MyBatsi Plusæœ‰æä¾›[æµ‹è¯•æ”¯æŒ](https://baomidou.com/pages/b7dae0/)ï¼Œä»…åŠ è½½æ•°æ®åº“ç›¸å…³å†…å®¹ã€‚

å¦‚ä¸‹è‡ªå®šä¹‰çš„æ³¨è§£ï¼ŒåŒ…å«äº†æ‰€æœ‰æµ‹è¯•å¿…é¡»çš„å†…å®¹

```java
@Inherited
@Documented
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
// mybatis plusçš„æµ‹è¯•æ”¯æŒ
@MybatisPlusTest
// å…³é—­æµ‹è¯•å®Œæˆåçš„äº‹åŠ¡å›æ»šï¼ˆ@MybatisPlusTesté»˜è®¤å¼€å¯ï¼Œä½†æˆ‘ä»¬æ˜¯å•å…ƒæµ‹è¯•å•ç‹¬çš„ç¯å¢ƒï¼Œæµ‹è¯•å®Œæˆåä¼šè¢«é”€æ¯ï¼Œå› æ­¤ä¸éœ€è¦ï¼‰
@Transactional(propagation = Propagation.NOT_SUPPORTED)
// å¯¼å…¥è‡ªå®šä¹‰çš„é’ˆå¯¹MyBatisçš„é…ç½®ï¼Œä¸»è¦æ˜¯Mapperæ‰«æä½ç½®
@Import(MyBatisConfig.class)
// æ‰«ædaoã€modelç­‰å†…å®¹
@ComponentScan("com.project5e.app.mylog.repo")
// PGçš„åµŒå…¥å¼æ•°æ®åº“å¼€å¯
@AutoConfigureEmbeddedDatabase(type = AutoConfigureEmbeddedDatabase.DatabaseType.POSTGRES, refresh = AutoConfigureEmbeddedDatabase.RefreshMode.AFTER_EACH_TEST_METHOD)
// åµŒå…¥å¼æ•°æ®åº“çš„åˆå§‹åŒ–èµ°Flyway
@FlywayTest
public @interface RepositoryTest {
}
```

## æµ‹ä»€ä¹ˆ

- æµ‹è¯•è¡¨å®Œæ•´æ€§
- æµ‹è¯•SQLæ­£ç¡®æ€§

## å…³äºFlyway

flywayçš„ä½¿ç”¨ï¼Œè‡ªè¡ŒæŸ¥é˜…æ‰‹å†Œï¼Œåœ¨è¿™é‡Œçš„ä½œç”¨æ˜¯ï¼šembedded-postresåœ¨å¯åŠ¨æœ¬åœ°æ•°æ®åº“åï¼Œå°†ä½¿ç”¨flywayå¯¹æ•°æ®åº“åˆå§‹åŒ–ã€‚æ‰€ä»¥ï¼Œsrc/db/migrationä¸‹çš„sqlå¿…é¡»ç»„æˆä¸€ä¸ªå®Œæ•´çš„æ•°æ®è¡¨ç¯å¢ƒã€‚

![image-20220305185526827](https://gdz.oss-cn-shenzhen.aliyuncs.com/local/image-20220305185526827.png)

## è¡¨å®Œæ•´æ€§æµ‹è¯•

åŒ…æ‹¬å¦‚ä¸‹å†…å®¹

- ä¸å¯ç©ºå­—æ®µæ£€æŸ¥
- å¯ç©ºæˆ–å…·æœ‰é»˜è®¤å€¼çš„å­—æ®µæ£€æŸ¥
- å”¯ä¸€ç´¢å¼•æ£€æŸ¥

ç”±äºæ¯ä¸ªè¡¨éƒ½éœ€è¦è¿›è¡Œå®Œæ•´æ€§æµ‹è¯•ï¼Œå› æ­¤æˆ‘ä»¬å†™æˆä¸€ä¸ªæŠ½è±¡ç±»ã€‚å­ç±»éœ€è¦æä¾›é¢„æœŸä¸å…è®¸ä¸ºç©ºçš„å­—æ®µåˆ—è¡¨ã€å…·æœ‰é»˜è®¤å€¼å­—æ®µå’Œé»˜è®¤å€¼æ˜ å°„ã€å”¯ä¸€ç´¢å¼•å’Œç”¨äºæµ‹è¯•å®ƒä»¬çš„æ•°æ®ã€‚

```kotlin
abstract class RepositoryIntegrityTest<M : BaseMapper<T>, T> {

    /**
     * éç©ºä¸”æ— é»˜è®¤å€¼çš„å­—æ®µ
     */
    abstract val nonNullableWithoutDefaultValueFields: List<KMutableProperty<*>>

    /**
     * å¯ç©ºæˆ–æœ‰é»˜è®¤å€¼çš„å­—æ®µ
     */
    abstract val nullableOrDefaultFields: Map<KMutableProperty<*>, Any?>

    /**
     * å”¯ä¸€ç´¢å¼•åˆ—è¡¨å’Œæµ‹è¯•å®ƒä»¬çš„æ•°æ®ï¼ˆå½“å­˜åœ¨å¤šä¸ªå”¯ä¸€ç´¢å¼•æ—¶ï¼Œæµ‹è¯•æ•°æ®ä¸å¥½é€ ï¼Œè¿˜æ˜¯äº¤ç»™å®ç°ç±»æ¯”è¾ƒå¥½ï¼‰
     */
    abstract val uniqueIndexesWithTestData: Map<List<KMutableProperty<*>>, List<T>>

    abstract fun getDao(): ServiceImpl<M, T>

    /**
     * æä¾›ä¸€ä¸ªæ‰€æœ‰å­—æ®µéƒ½ä¸ä¸ºç©ºçš„åŸºç¡€modelï¼Œç”¨äºæµ‹è¯•
     */
    abstract fun createModelWithAllFieldNotNull(): T

    @Test
    fun `validate when field absent (without default value)`() {
        assertAll {
            nonNullableWithoutDefaultValueFields.forEach { prop ->
                // å¾…æµ‹å­—æ®µå¡«å……null
                val mockModel = createModelWithAllFieldNotNull().apply { prop.setter.call(this, null) }
                // å¡«å……nullçš„å­—æ®µéƒ½æœ‰åº”è¯¥æŠ¥é”™
                val result = Result.runCatching { getDao().save(mockModel) }
                assertThat(result, prop.name).isFailure().matchesPredicate {
                    val nameInDb = StringUtils.camelToUnderline(prop.name)
                    it.message!!.contains("""null value in column "$nameInDb" violates not-null constraint""")
                }
            }
        }
    }

    @Test
    fun `validate when field absent (with default value)`() {
        // æ¸…ç©ºæ•°æ®åº“
        clearTable()
        // å­—æ®µå¡«å……null
        val mockModel = createModelWithAllFieldNotNull().apply {
            nullableOrDefaultFields.forEach { (prop, _) ->
                prop.setter.call(this, null)
            }
        }
        // ä¿å­˜ç„¶åæŸ¥å‡º
        getDao().save(mockModel)
        val insertedModel = getDao().list().first()
        // æ‰€æœ‰è®¾ç½®ä¸ºnullçš„å­—æ®µæŸ¥è¯¢ç»“æœéƒ½åº”è¯¥ä¸é¢„æœŸçš„ä¸€è‡´
        assertAll {
            nullableOrDefaultFields.forEach { (prop, expectedValue) ->
                if (expectedValue != null && expectedValue::class == Any::class) {
                    assertThat(prop.getter.call(insertedModel), prop.name).isNotNull()
                } else {
                    assertThat(prop.getter.call(insertedModel), prop.name).isEqualTo(expectedValue)
                }
            }
        }
    }

    @Test
    fun `validate unique constraint`() {
        clearTable()
        // æ„å»ºä¸¤ä¸ªæ‹¥æœ‰ä¸€æ ·å­—æ®µå€¼çš„å¯¹è±¡
        assertAll {
            uniqueIndexesWithTestData.forEach { (index, testModels) ->
                val result = Result.runCatching { getDao().saveBatch(testModels) }
                assertThat(result, index.toString()).isFailure().isInstanceOf(DuplicateKeyException::class)
                    .matchesPredicate {
                        it.message!!.contains("already exists")
                    }
            }
        }
    }

    fun clearTable() {
        getDao().ktUpdate().remove()
    }

}
```

ä»¥è¡¨senior_userä¸ºä¾‹ï¼Œå®ç°å®ƒå¦‚ä¸‹

```kotlin
@RepositoryTest
class SeniorTest : RepositoryIntegrityTest<SeniorUserMapper, SeniorUserModel>() {

    @Autowired
    private lateinit var seniorUserDao: SeniorUserDao

    override val nonNullableWithoutDefaultValueFields: List<KMutableProperty<*>> = listOf(
        SeniorUserModel::id
    )

    override val nullableOrDefaultFields: Map<KMutableProperty<*>, Any?> = mapOf(
        SeniorUserModel::createdTime to Any(),
        SeniorUserModel::updatedTime to Any(),
        SeniorUserModel::redeemed to false
    )

    override val uniqueIndexesWithTestData: Map<List<KMutableProperty<*>>, List<SeniorUserModel>> = mapOf(
        listOf(SeniorUserModel::id) to listOf(createModelWithAllFieldNotNull(), createModelWithAllFieldNotNull())
    )

    override fun getDao(): ServiceImpl<SeniorUserMapper, SeniorUserModel> {
        return seniorUserDao
    }

    final override fun createModelWithAllFieldNotNull(): SeniorUserModel {
        return SeniorUserModel().apply {
            this.id = MOCK_USER_ID.toLong()
            this.createdTime = OffsetDateTime.now()
            this.updatedTime = OffsetDateTime.now()
            this.redeemed = false
        }
    }
}
```

## SQLæ­£ç¡®æ€§æµ‹è¯•

é€šå¸¸çš„åšæ³•æ˜¯ï¼šæ„å»ºmockæ•°æ®ï¼Œæ’å…¥æ•°æ®åº“ -> è°ƒç”¨è¢«æµ‹SQL -> åˆ¤æ–­ç»“æœ

```kotlin
@Test
fun `test update user info partially`() {
  // æ¸…ç©ºè¡¨
  clearTable()
  // æ„å»ºæµ‹è¯•æ•°æ®
  val oldModel = createModelWithAllFieldNotNull()
  userDao.save(oldModel)

  // è°ƒç”¨è¢«æµ‹SQLæ–¹æ³•
  val mockUserId = MOCK_USER_ID
  val mockUserName = MOCK_USER_NAME + "gt"
  val mockRequest = UserUpdateReq().apply {
    this.name = mockUserName
  }
  userDao.updateUserInfo(mockUserId, mockRequest)
  // å–å‡ºæ•°æ®
  val newModel = userDao.getById(mockUserId)
	// åˆ¤æ–­ç»“æœ
  assertThat(newModel.id).isEqualTo(mockUserId)
  assertThat(newModel.name).isEqualTo(mockRequest.name)
  assertThat(newModel.avatar).isEqualTo(oldModel.avatar)
  assertThat(newModel.description).isEqualTo(oldModel.description)
}
```

è¢«æµ‹SQLå¦‚ä¸‹ï¼ˆå½“ç„¶å®ƒä¹Ÿä¸ä¸€å®šæ˜¯ä¸ªSQLï¼Œä¹Ÿå¯èƒ½æ˜¯åŸºäºåº•å±‚åº“æ„å»ºçš„å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œæ¯”å¦‚è¿™é‡Œï¼‰

```kotlin
fun updateUserInfo(id: Int, request: UserUpdateReq): Boolean {
  return UserModel(
    id = id,
    name = request.name,
    avatar = request.avatar,
    description = request.description,
  ).run { updateById() }
}
```

## MyBatis Plusçš„SQLå†™åœ¨å“ªé‡Œ

MyBatis Plusæä¾›äº†ç±»`public class ServiceImpl<M extends BaseMapper<T>, T> implements IService<T>`ï¼Œæä¾›ä¸‰ä¸ªèƒ½åŠ›

- å¿«æ·æ–¹æ³•ï¼Œå¦‚saveã€listã€getByIdç­‰
- æä¾›å†™SQLçš„DSLèƒ½åŠ›
- æä¾›baseMapperï¼Œå¯¹mapperç›´æ¥è°ƒç”¨

å¦‚æ­¤æ–¹ä¾¿ï¼Œä»¥è‡³äºå¾ˆå¤šä¸šåŠ¡å°†Serviceç±»ç»§æ‰¿äº†å®ƒï¼Œçœå»äº†å®šä¹‰DAOçš„éº»çƒ¦ã€‚ä¸ªäººè®¤ä¸ºï¼Œè¿™æ ·åšåœ¨èƒ½åŠ›1å’Œèƒ½åŠ›3çš„ä½¿ç”¨ä¸Šéƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†åˆ©ç”¨DSLæ„å»ºSQLçš„èƒ½åŠ›å¯¹Serviceå±‚é€ æˆäº†å…¥ä¾µï¼Œè‡³å°‘å®ƒä¸æ˜¯å®¹æ˜“æµ‹è¯•çš„ä»£ç ï¼š

- å¦‚æœæ„å»ºçš„SQL DSLå’Œä¸šåŠ¡ä»£ç æ··åœ¨ä¸€èµ·ï¼Œåˆ™æ ¹æœ¬æ— æ³•æµ‹è¯•
- å¦‚æœå°†å…¶ææˆä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ä¸“é—¨å®šä¹‰ä¸€ä¸ªDAOæ¥è´Ÿè´£å‘¢ï¼Ÿèƒ½åŠ›1å’Œèƒ½åŠ›3è°ƒç”¨çš„æ–¹ä¾¿æ€§æ²¡æœ‰å˜å·®ï¼Œèƒ½åŠ›2ä¹Ÿå¾—åˆ°äº†çš„æœ‰æ•ˆç®¡æ§

æ‰€ä»¥æˆ‘çš„çœ‹æ³•æ˜¯ï¼šåº”è¯¥å°†ServiceImplé”å®šåœ¨DAOé‡Œï¼Œä¸è¦ä¾µå…¥åˆ°ä¸šåŠ¡ä»£ç ã€‚

## æµ‹è¯•é”

å¦‚ä¸‹SQLå¦‚ä½•æµ‹è¯•ï¼Œæµ‹è¯•é‡ç‚¹åœ¨äºFOR UPDATE

```kotlin
fun lockUser(userId: Int) {
  ktQuery()
  .eq(UserModel::id, userId)
  .last("FOR UPDATE")
  .list()
}
```

åˆ†æéš¾ç‚¹åŠè§£å†³æ–¹æ¡ˆ

- éœ€è¦åœ¨ä¸¤ä¸ªå¹¶å‘çš„äº‹ç‰©ä¸­åˆ†åˆ«è°ƒç”¨æ‰èƒ½æµ‹è¯•

  å¯ä»¥åˆ©ç”¨çº¿ç¨‹+æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡+å»¶è¿Ÿ

- å¦‚ä½•éªŒè¯æ˜¯å¦æˆåŠŸ

  ä½¿ç”¨`SELECT XXXX FOR UPDATE NOWAIT`è¯­å¥ï¼Œæ£€æµ‹åˆ°é”å†²çªæ—¶é©¬ä¸ŠæŠ¥é”™

äºæ˜¯ä»£ç å¯ä»¥å¦‚ä¸‹

```kotlin
// äº‹åŠ¡ç®¡ç†å™¨ï¼Œç›´æ¥æ³¨å…¥å³å¯
@Autowired
private lateinit var tm: DataSourceTransactionManager

@Test
fun `test lock user`() {
  // æ³¨æ„latchçš„ä½¿ç”¨
  val latch = CountDownLatch(2)

  val transaction1 = Runnable {
    // æ³¨æ„ç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹å¼
    val transactionStatus = tm.getTransaction(TransactionDefinition.withDefaults())
    userDao.lockUser(MOCK_USER_ID)
    TimeUnit.SECONDS.sleep(2)
    tm.commit(transactionStatus)
    latch.countDown()
  }
  val transaction2 = Runnable {
    TimeUnit.SECONDS.sleep(1)
    val transactionStatus = tm.getTransaction(TransactionDefinition.withDefaults())
    try {
      assertThat {
        userDao.ktQuery().eq(UserModel::id, MOCK_USER_ID).last("FOR UPDATE NOWAIT").list()
      }.isFailure().isInstanceOf(CannotAcquireLockException::class)
    } finally {
      tm.commit(transactionStatus)
      latch.countDown()
    }
  }

  Thread(transaction1).start()
  Thread(transaction2).start()
  latch.await()
}
```

# é—®é¢˜è®°å½•

- ä½¿ç”¨@WebMvcTestå•ç‹¬æµ‹è¯•Controlleræ—¶ï¼ŒæŠ¥é”™ï¼šæ— æ³•æ‰¾åˆ°xxxMapper

  åŸå› ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œ@WebMvcTestä¼šå°†SpringBootApplicationæ³¨è§£çš„é‚£ä¸ªå¯åŠ¨ç±»å½“åšé…ç½®ä¸»ç±»ï¼Œè€Œä¹‹å‰å°†@MapperScanå†™åœ¨äº†ä¸Šé¢ã€‚

  è§£å†³ï¼šå°†@MapperScanè½¬ç§»åˆ°å•ç‹¬çš„é…ç½®æ–‡ä»¶ä¸­ã€‚åŒæ—¶ä¹Ÿæé†’ï¼šé…ç½®ä¸è¦ä¹±æ”¾

- logback-test.xmlä¸­æŒ‡å®šçš„æ—¥å¿—ç­‰çº§ä¸ç”Ÿæ•ˆ

  åŸå› ï¼šå¦‚æœåœ¨src/main/resources/application.propertiesä¸­æŒ‡å®šäº†logging.root.levelï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­çš„ç­‰çº§å°±ä¸ä¼šç”Ÿæ•ˆ

  è§£å†³ï¼šç§»é™¤logging.root.level

  è¦å½»åº•è§£å†³ï¼Œå¯ä»¥å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://www.notion.so/TDD-e8c9e51b1c28483c890a9a3ddc12338d#1fea41c4163f4fc7a64c75aa756b7f4c)

- é…ç½®é—®é¢˜ï¼šControlleræµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°ä¸€äº›é’ˆå¯¹Webçš„é…ç½®æœªç”Ÿæ•ˆ

  åŸå› ï¼šé…ç½®ç±»æœªè¢«@WebMvcTeståŠ è½½

  è§£å†³ï¼šæ‰‹åŠ¨å¯¼å…¥è‡ªå®šä¹‰çš„Webé…ç½®

- Kotlinå…¼å®¹æ€§é—®é¢˜ï¼š@NotBlankå¯¹å†™åœ¨æ„é€ æ–¹æ³•ä¸­çš„Kotlinå±æ€§ä¸ç”Ÿæ•ˆ

  åŸå› ï¼šéªŒè¯åº“å’ŒKotlinçš„å…¼å®¹æ€§é—®é¢˜

  è§£å†³ï¼šä½¿ç”¨@field:NotBlankæˆ–è€…å°†å±æ€§ä»æ„é€ æ–¹æ³•ç§»åˆ°ç±»ä½“

- MockKæ— æ³•è°ƒç”¨ã€mockç§æœ‰æ–¹æ³•

  è§£å†³ï¼šMockKæä¾›è¿™æ ·çš„åŠŸèƒ½ï¼Œä½†ä½¿ç”¨èµ·æ¥ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚æ‰€ä»¥è¿™ä¸ªé—®é¢˜å°šæœªæœ‰è¾ƒå¥½çš„è§£å†³æ–¹å¼

# æ€»ç»“

æˆ‘èŠ±äº†ä¸¤å‘¨å»äº†è§£å•å…ƒæµ‹è¯•å¸¸ç”¨æŠ€æœ¯ï¼Œç»†è¯»JUnitç”¨æˆ·æ‰‹å†Œï¼Œæµè§ˆäº†Spring Boot Testæ‰‹å†Œï¼ˆä½†æ˜¯å¿˜è®°çœ‹Spring Testæ‰‹å†Œï¼Œæ˜¯è¯´ç”¨çš„æ—¶å€™è§‰å¾—å“ªé‡Œä¸å¯¹ï¼ŒğŸ˜“ï¼‰ï¼Œå»äº†è§£äº†å¦‚ä½•æ­£ç¡®åœ°å†™å•å…ƒæµ‹è¯•ã€‚åˆèŠ±äº†ä¸¤å‘¨å¯¹æ¯è®°åç«¯é¡¹ç›®è¿›è¡ŒTDDé‡æ„ï¼Œå…ˆåå°è¯•äº†Mockitoã€AssertJå’ŒMockKã€AssertKï¼Œå‘ç°ç”¨Kotlinæ—¶ï¼ŒMockKæ¯”Mockitoé¦™å¾—ä¸æ˜¯ä¸€ç‚¹ç‚¹ï¼ˆMockitoå†™å¾—åƒJavaï¼Œmocké™æ€æ–¹æ³•æ—¶è¿˜å¾—æ‰“è¡¥ä¸ï¼Œå¯¹Kotlin DSLçš„è¡¥ä¸çœ‹èµ·æ¥å¹¶ä¸ç‰¹åˆ«å¥½ï¼›MockKå°±ä¸ä¸€æ ·äº†ï¼ŒåŠŸèƒ½å…¨é¢ï¼Œä½¿ç”¨ä¼˜é›…ï¼‰ã€‚

åœ¨è¡¥å•å…ƒæµ‹è¯•æ—¶ï¼Œè¿˜ä¿®å¤äº†ä¸€äº›ä¹‹å‰æ²¡æ³¨æ„ä¹Ÿæ²¡æµ‹å‡ºæ¥çš„bugï¼Œæ‰€è°“çŸ«æ‰è¿‡æ­£ï¼Œç°åœ¨çš„æˆ‘è§‰å¾—æ²¡æœ‰å•å…ƒæµ‹è¯•çš„ä»£ç ï¼Œæ˜¯éå¸¸ä¸å¯é çš„ã€‚

æœ¬å‘¨å¼€å‘æ–°åŠŸèƒ½æ—¶ï¼ŒåŒæ­¥æ·»åŠ å•å…ƒæµ‹è¯•ã€‚ä¸¤ç‚¹æ„Ÿå—é¢‡æ·±

- å†™èµ·æ¥ç¡®å®æ”¾å¿ƒä¸å°‘ã€‚å†™æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå·²ç»ç»†ç»†å“è¿‡å¾ˆå¤šè¾¹ç¼˜caseäº†ã€‚ä¹Ÿçœå»äº†æœ¬åœ°å¯åŠ¨æœåŠ¡ä¸€ééæ‰‹åŠ¨æµ‹è¯•çš„éº»çƒ¦ã€‚
- æ˜¯çœŸçš„æŒºèŠ±è´¹æ—¶é—´ã€‚æ‰ªå¿ƒè‡ªé—®ï¼Œå¦‚æœè¿›åº¦è¦æ±‚å†æ€¥ä¸€ç‚¹ï¼Œè¿™å•å…ƒæµ‹è¯•å¯èƒ½å†™ä¸ä¸‹å»ï¼Œè¿˜å¾—åé¢è¡¥ã€‚æ‰€ä»¥ï¼Œè¦ç»™è‡ªå·±é¢„ç•™å……è¶³çš„æ—¶é—´ã€‚

å›çœ‹åˆšå†™çš„è¿™äº›å•æµ‹ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šé—®é¢˜çš„

- caseæ•°é‡å¤šï¼Œå½“å‰æœ‰å°†è¿‘300ä¸ªcaseï¼ˆç®—ä¸Šæ¡ä»¶æµ‹è¯•ï¼‰ã€‚æ ¹æ®80%çš„bugå‡ºåœ¨20%ä»£ç ä¸­çš„å®šå¾‹ï¼Œå¯ä»¥ä¾é ç»éªŒè¯†åˆ«å®¹æ˜“å‡ºé—®é¢˜çš„åœ°æ–¹ï¼Œé›†ä¸­æµ‹è¯•ï¼Œå…¶å®ƒåœ°æ–¹ï¼Œç›¸å¯¹å¯ä»¥æ”¾æ¾è­¦æƒ•ã€‚è¿™æ ·èƒ½å¤ŸèŠ‚çœå†™å•æµ‹æ—¶é—´
- æµ‹è¯•é€Ÿåº¦æ…¢ï¼ŒCIæœºä¸Šè·‘å®Œæ‰€æœ‰caseéœ€è¦2:30å·¦å³ã€‚é€Ÿåº¦æœ‰å¾…ä¼˜åŒ–
- æµ‹è¯•ä»£ç è´¨é‡æœ‰å¾…åŠ å¼º

è€Œå°±æ•´ä¸ªæµ‹è¯•å·¥ä½œæ¥è¯´ï¼Œè¦åšçš„ä¹Ÿè¿˜æœ‰å¾ˆå¤š

- é›†æˆæµ‹è¯•ï¼šç›®å‰æ²¡æœ‰é›†æˆæµ‹è¯•ï¼Œæ‰€ä»¥å„å±‚çš„åä½œè¿˜æ˜¯é æ‰‹åŠ¨æµ‹è¯•
- CI+æ¥å£æµ‹è¯•è‡ªåŠ¨åŒ–ï¼šå½“å‰CIè´Ÿè´£ä»æ„å»ºã€å•å…ƒæµ‹è¯•ã€å‘å¸ƒåº”ç”¨çš„è¿‡ç¨‹ï¼›è¿˜å¯ä»¥æ›´åŠ è‡ªåŠ¨åŒ–ï¼šå‘å¸ƒä½¿ç”¨é‡‘ä¸é›€ï¼Œæ£€æµ‹åº”ç”¨å‘å¸ƒå®Œæˆåå¯¹æ‰€æœ‰æ¥å£è¿›è¡Œå†’çƒŸæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡å†æ›¿æ¢å®é™…åº”ç”¨ï¼Œå¦åˆ™å°±åªå‘å¸ƒé‡‘ä¸é›€ï¼Œä»è€Œæœ€å¤§ç¨‹åº¦é™ä½å‘å¸ƒé£é™©ã€‚
- æ¨å¹¿å•å…ƒæµ‹è¯•ï¼šå•æµ‹å€¼å¾—æ¨å¹¿å—ï¼Ÿè‚¯å®šæ˜¯å€¼å¾—çš„ã€‚ä½†è¯´å®è¯ï¼Œè®©æˆ‘å»å†™tableåº”ç”¨çš„å•å…ƒæµ‹è¯•ï¼Œæˆ‘ä¹Ÿä¼šå¿ƒç”ŸæŠ—æ‹’ï¼Œæ¯•ç«Ÿcaseå¤ªå¤šäº†ã€‚å¦‚æœå…‹æœè¿™äº›é—®é¢˜ï¼Œè®©å¤§å®¶è®¤çœŸå†™æµ‹è¯•ï¼Œæ˜¯ä¸ªè¯¾é¢˜ã€‚
